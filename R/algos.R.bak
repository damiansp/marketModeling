#---------#---------#---------#---------#---------#---------#---------#---------
load('~/Desktop/marketStudies/data/myHistoric.RData')
head(df)
tail(df)

dailyChange <- function(x) {
  (x[2:length(x)] - x[1:(length(x) - 1)]) / x[1:(length(x) - 1)]
}

m <- dim(df)[1]
last <- m

wlsh.osc <- c(
  414,415,416,417,418,416,415,413,414,416,419,422,427,430,435,443,436,425,403, 
  389,369,344,337,326,313,297,279,256,239,213,189,173,163,151,143,137,128,127,
  120,119,121,126,135,142,144,146,146,140,136,130,126,123,113,102, 79, 61, 37, 
   22, 14, 13, 20, 25, 34, 41, 50, 54, 63, 76, 86, 90, 97,100,105,116,125,134,
  140,149,156,163,173,181,190,193,196,198,197,200,203,208,211,212,212,212,212,
  213,211,210,209.709)

SPActual <- c(df$SPActual,
  3258, 3235, 3246, 3237, 3253, 3275, 3265, 3288, 3283, 3289, 3317, 3330, 3321, 
  3322, 3326, 3295, 3244, 3276, 3273, 3284, 3226, 3249, 3298, 3335, 3346, 3328,
  3352, 3358, 3379, 3374, 3380, 3370, 3386, 3373, 3338, 3226, 3128, 3116, 2979,
  2954, 3090, 3003, 3130, 3024, 2972, 2747, 2882, 2741, 2481, 2711, 2386, 2529,
  2398, 2409, 2305, 2237, 2447, 2476, 2630, 2541, 2627, 2585, 2471, 2527, 2489,
  2664, 2659, 2750, 2790, 2762, 2846, 2783, 2800, 2875, 2823, 2737, 2799, 2798,
  2837, 2878, 2863, 2940, 2912, 2831, 2843, 2868, 2848, 2881, 2930, 2930, 2870,
  2820, 2853, 2864, 2954, 2923, 2972, 2949, 2955, 2992, 3036, 3030, 3044, 3056,
  3081, 3123, 3112, 3194, 3232, 3207, 3190, 3002, 3041, 3067, 3125, 3113, 3115,
  3098, 3118, 3131, 3050, 3084, 3009, 3053, 3100, 3116, 3130, 3180, 3145, 3170,
  3152, 3185, 3155, 3198, 3227, 3216, 3225, 3252, 3257, 3276, 3236, 3216, 3239,
  3218, 3258, 3246, 3271, 3295, 3307, 3328, 3349, 3351, 3360, 3334, 3380, 3373,
  3373, 3382, 3390, 3375, 3386, 3397, 3431, 3444, 3479, 3485, 3508, 3500, 3527,
  3581, 3455, 3427, 3332, 3399, 3339, 3341, 3384, 3401, 3385, 3357, 3319, 3281,
  3316, 3237, 3247, 3298, 3352, 3335, 3363, 3381, 3348, 3409, 3361, 3419, 3447,
  3477, 3534, 3512, 3489, 3483, 3484, 3427, 3443, 3436, 3453, 3465, 3401, 3391,
  3271, 3310, 3270, 3310, 3369, 3443, 3510, 3509, 3551, 3546, 3573, 3537, 3585,
  3627, 3610, 3568, 3582, 3558, 3578, 3635, 3630, 3638, 3622, 3662, 3669, 3667,
  3699, 3692, 3702, 3673, 3668, 3663, 3647, 3695, 3701, 3722, 3709, 3695, 3687,
  3690, 3703, 3735, 3727, 3732, 3756)
SP <- SPActual / SPActual[last]
SPd <- dailyChange(SP)

FidIn <- c(df$FidIn, 
  49272,49272,49272,49272,49272,49272,49272,49272,49272,49272,49606,49606,49606,
  49606,49606,49606,49606,49606,49606,49606,49967,49967,49967,49967,49967,49967,
  49967,49967,49967,49967,49967,50518,50518,50518,50518,50518,50518,50772,50997,
  51624,52450,52450,52450,52575,52575,52575,52575,53305,53338,53520,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,53922,
  53922,53922,53922,53922,53922,53922,53922,53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922, 53922,
   53922) #
FidVal <- c(df$FidVal,
  67207,66964,67836,67845,68350,69182,69150,70292,70021,70325,71449,71241,71481,
  71914,71973,71797,70797,71948,72261,72758,71959,72653,74612,73052,73461,73088,
  74098,74239,75216,75289,75656,76764,77015,76669,75445,73623,72321,72568,72423,
  73977,75502,73877,76162,75986,73578,68424,71999,68494,63914,66457,59275,62287,
  61137,64169,63505,65990,70697,69486,72212,70461,71589,70670,67710,66576,65762,
  70399,69788,72290,74006,74344,75225,75691,76505,76992,77454,76942,77313,77382,
  77655,77739,77447,77499,77389,77236,77501,77522,77543,77742,77740,77969,77818,
  77661,77589,77703,77736,77778,77821,77815,77774,77677,77661,77744,77870,77947,
  77933,77862,75954,76348,77897,77473,79183,75955,77075,80362,81150,82232,83702,
  84379,84379,84379,84379,84379,84379,84379,84379,84380,84380,84380,84380,84380,
  84380,84387,84084,84198,84445,84373,84584,85203,84959,85150,84887,84670,84991,
  85053,85081,85470,85458,85928,85988,85954,85761,85228,84859,84442,84595,85003,
  84842,85253,85619,85482,85775,85641,85358,85566,
   86233, 86123, 86044, 86307, 87249, 87362, 85744, 84809, 84146, 84921, 84466,
   83926, 84666, 85308, 84974, 84771, 85164, 86529, 87763, 86618, 86064, 88036,
   88599, 88970, 89472, 91049, 90394, 91562, 91958, 93511, 93765, 94836, 95026,
   96308, 95804, 94573, 94115, 94173, 93715, 92524, 92056, 92829, 91855, 93047,
   91543, 91752, 88112, 87811, 89110, 92872, 95704, 97054, 92442, 90175, 92301,
   92530, 92401, 92320, 93167, 93107, 94607, 95551, 95894, 95374, 96423, 97217,
   98172, 97360, 97033, 98025, 98730, 99134,100032, 98498,100458,100749,100712,
  101278,101704,103070,103387,103909,105177,104626,104534,102570,102316,102718,
  101989)
Fid <- FidVal / FidIn
Fid <- Fid / Fid[last]
Fidd <- dailyChange(Fid)

f1kIn <- c(df$f1kIn, 
  62922,63055,63055,63055,63055,63055,63055,63055,63055,63055,63799,63799,63799,
  63799,63799,63799,63799,63799,63799,63799,64589,64589,64589,64589,64589,64589,
  64589,64589,64589,64589,64589,65350,65350,65350,65350,65350,65350,65350,65350,
  65350,66201,66201,66201,66201,66201,66201,66201,66201,66201,66201,67171,67171,
  67171,67171,67171,67171,67171,67171,67171,67171,67171,67171,68101,68101,68101,
  68101,68101,68101,68101,68101,68101,68101,68999,68999,68999,68999,68999,68999,
  68999,68999,68999,68999,68999,69896,69896,69896,69896,69896,69896,69896,69896,
  69896,69896,69896,70793,70793,70793,70793,70793,70793,70793,70793,70793,71689,
  71689,71689,71689,71689,71689,71689,71689,71689,71689,72604,72604,72604,72604,
  72604,72604,72604,72604,72604,72604,72604,72604,73503,73503,73503,73503,73503,
  73503,73503,73503,73503,73503,73503,73503,73503,74321,74321,74321,74321,74321,
  74321,74321,74321,74321,75133,75133,75133,75133,75133,75133,75133,75133,75133,
  75133,75921,75921,75921,75921,75921,75921,75921,
   75921, 75921, 75921, 75921, 76682, 76682, 76682, 76682, 76682, 76682, 76682,
   76682, 76682, 77480, 77480, 77480, 77480, 77480, 77480, 77480, 77480, 77480,
   77480, 77480, 77480, 78262, 78262, 78262, 78262, 78262, 78262, 78262, 78262,
   78262, 78262, 78262, 79015, 79015, 79015, 79015, 79015, 79015, 79015, 79015,
   79015, 79015, 79015, 79794, 79794, 79794, 79794, 79794, 79794, 79794, 79794,
   79794, 79794, 79794, 80542, 80542, 80542, 80542, 80542, 80542, 80542, 80542,
   80542, 81278, 81278, 81278, 81278, 81278, 81278, 81278, 81278, 81278, 81278,
   81278, 81977, 81977, 81977, 81977, 81977, 81977, 81977, 81977, 81977, 81977,
   81977) #
f1kVal <- c(df$f1kVal,
  78724,79717,79266,79597,79663,80119,80830,80643,81402,81202,82305,83083,83340, 
  83075,83246,83325,82584,82245,82245,82229,82210,82210,83468,85236,84974,85222,
  84586,85445,85616,86280,86433,87908,87968,88741,88321,87123,84239,81739,81394,
  78230,79164,82166,80067,82822,80735,79643,75583,74678,74678,69536,74436,67483,
  69875,66581,67959,66525,65914,70631,71348,73900,71972,73543,71333,71333,72192,
  71410,75385,75326,76770,74344,77254,77276,78277,78282,78311,78299,78276,78293,
  78296,78305,78328,78329,78378,79379,79356,79361,79374,79375,79396,79396,79397,
  79377,79359,79370,80395,80427,80421,80435,80430,80436,80451,80463,80477,81506,
  81512,81523,81542,81532,83185,83891,83728,84109,79770,80555,82692,83923,84104,
  84282,84243,85341,85341,83196,82281,82281,83294,85858,86599,87158,89046,88496,
  89469,90351,88680,89924,91794,91794,91167,91745,93546,93008,93499,91737,91210,
  92616,91597,93101,93223,94835,95919,96273,97503,97503,96864,96263,95413,96827,
  97133,98051,98864,99107,98637,99198,99501,99806,
  100297,101284,101230,101669,103236,103966,104624,101156,100214, 98483, 99262,
   98105, 97910, 99313,101102,100400, 99642, 99157, 98995, 99873, 97960, 98232,
   99677,100949,100933,102464,103354,102072,103619,102550,103936,104258,105021,
  106256,106354,105854,106613,106469,105370,105537,105410,105603,106128,104867,
  105095,102574,103300,102287,102887,104257,106706,109044,109044,107717,106438,
  107739,108099,108708,109333,109206,109333,109079,109079,109652,110415,110730,
  111448,112547,113179,113401,113401,114300,114699,113617,113617,111306,114041,
  114205,116472,116866,118028,117748,117748,118156,117799,117799,117650,117324,
  117661)
payment <- 1018.67
n <- length(f1kIn)
payment * f1kIn[n] / f1kVal[n] + f1kIn[n]

f1k <- f1kVal / f1kIn
f1k <- f1k / f1k[last]
f1kd <- dailyChange(f1k)

OHIn <- c(df$OHIn,
  39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,
  39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,
  39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,
  39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39139,39316,39316,
  39316,39316,39316,39316,39316,39316,39316,39316,39316,39316,39922,39922,39922,
  39922,39922,39922,39922,39922,39922,39922,40169,40169,40169,40169,40169,40169,
  40169,40169,40169,40169,40433,40433,40433,40433,40433,40433,40433,40433,40433,
  40433,40433,40433,40755,41491,41491,41491,41491,41491,41491,41491,41491,41773,
  41773,41773,41773,41773,41773,41773,41773,41773,41773,42058,42058,42058,42058,
  42058,42058,42058,42058,42058,42058,42058,42058,42298,42298,42298,42298,42298,
  42298,42298,42298,42298,42298,42522,42522,42522,42522,42522,42522,42522,42522,
  42522,42522,42522,42522,42904,42904,42904,42904,42904,42904,42904,42904,42904,
  43177,43177,43177,43177,43177,43177,43177,43177,
   43177, 43177, 43177, 43463, 43463, 43463, 43463, 43463, 43463, 43562, 43562,
   43562, 43562, 43828, 43828, 43828, 43828, 43828, 43828, 43828, 43828, 43828,
   43828, 43828, 44089, 44089, 44089, 44089, 44089, 44089, 44089, 44089, 44089,
   44089, 44089, 44089, 44227, 44227, 44227, 44227, 44227, 44227, 44227, 44227,
   44227, 44266, 44266, 44564, 44564, 44564, 44564, 44564, 44564, 44564, 44564,
   44564, 44564, 44838, 44838, 44838, 44838, 44838, 44838, 44838, 44838, 44838,
   45081, 45081, 45081, 45081, 45081, 45081, 45081, 45081, 45081, 45081, 45081,
   45081, 45347, 45347, 45347, 45347, 45347, 45347, 45347, 45347, 45347, 45347,
   45347) # 1283 + 187
   
OHVal <- c(df$OHVal, 
  57209,57005,57743,57775,58218,58930,58902,59932,59667,59935,60474,60297,60486,
  60859,60906,60764,59913,60889,61146,61555,60455,61021,62706,61379,61724,61387,
  62208,62310,63141,63215,63535,63763,63987,63714,62713,61146,60028,59923,59490,
  60064,60830,59581,61221,61034,59152,55207,57094,54358,50677,52652,47653,49863,
  48829,50685,50109,51266,54500,54064,55725,54522,55336,54792,53712,53052,52492,
  55308,54983,56569,57470,57934,60039,60184,61108,61804,62293,61128,61958,61869,
  62152,62354,62163,62627,62871,62481,62990,63519,64322,64789,65237,65688,65475,
  65246,65256,65667,66186,67651,68156,68172,68723,68081,67731,67972,68768,69525,
  69652,69503,68609,68779,69362,69002,70645,67416,68389,71363,72235,72944,74341,
  74549,74549,74549,74549,74549,74549,74549,74549,74975,74975,74975,74975,74975,
  74975,74980,74262,74338,74433,74687,74826,75627,75372,75478,75134,74965,75282,
  75339,75568,75959,76234,77500,77621,77310,77108,76433,75822,75337,75551,76065,
  76387,76827,77168,77064,77305,77185,76941,77174,
   77824, 77643, 77733, 78549, 79674, 79743, 77682, 76796, 76104, 77023, 76579,
   76051, 76705, 77678, 77273, 77009, 77281, 78352, 79412, 78362, 77868, 79658,
   80202, 80605, 81527, 83101, 82510, 83627, 84206, 85616, 85818, 87077, 87447,
   88736, 88030, 87290, 87177, 87290, 86772, 85636, 85168, 86026, 85019, 86308,
   84601, 84909, 81199, 81504, 82764, 86348, 88878, 90343, 85585, 83818, 86055,
   86311, 85792, 86210, 87108, 86949, 89027, 90338, 90564, 89596, 91045, 92532,
   94294, 93169, 92728, 93760, 94511, 94882, 96091, 94241, 96848, 97324, 97500,
   98353, 99476,101326,101706,102577,104645,103619,103598,100491,100092,100799,
   99685)
OH <- OHVal / OHIn
OH <- OH / OH[last]
OHd <- dailyChange(OH)
totalFunds <- FidVal + f1kVal + OHVal


# Actual Strategy (Nug-o-War 2020)
m1 <- (c(
  100000,102171,101151,104948,104587,106456,109442,109179,113965,112709,113654,
  115957,115050,115744,116736,116830,115816,111672,116107,117320,119270,114147,
  116834,124719,119085,120695,119045,122772,123457,127710,128373,128859,130639,
  132291,131083,125791,117154,110794,110002,108256,110575,114828,109427,117011,
  116092,108896, 92710,101219, 88922, 72191, 75737, 58589, 68349, 64235, 71723,
   69464, 76402, 90198, 87748, 95970, 91275, 94738, 91779, 83994, 81280, 78498,
   91170, 89254, 95835, 99328,101805,110861,112407,117228,122595,127624,125101,
  126466,126345,127074,126764,126551,126981,126975,126960,126981,126991,126997,
  127026,127041,127058,127075,127063,127047,127053,127068,127068,127078,127080,
  127078,127071,127058,127055,127069,127087,127097,127084,120586,121977,127046,
  125386,131782,119254,123099,133124,136778,140187,145284,148269,155253,155565,
  149207,155177,152985,150630,155991,164845,167047,167951,169382,177825,182305,
  178987,160353,161820,163719,159773,162564,176689,171832,171952,164920,162824,
  169908,166466,176779,183866,187616,196766,197814,197421,191939,176978,169073,
  161144,164073,170791,168087,174304,178787,177376,181355,179578,176445,178993,
  186558,185586,184610,187295,197120,196569,176607,168823,162054,168923,165169,
  161270,166967,170843,167922,165858,168388,174187,181897,174728,172396,182492,
  185734,187496,190305,198638,195337,201457,204667,212261,213019,219853,221424,
  227574,223366,218303,217669,218199,216217,210299,208649,212701,207972,213799,
  205540,207888,191628,189748,196060,212194,225084,232754,207787,197805,210267,
  210568,209860,208888,213766,212701,223400,229892,231505,227355,235161,242222,
  248295,243286,240734,245650,248421,251696,257890,248819,263184,266066,266749,
  271099,274289,283281,286313,289926,300889,292485,292845,276456,274653,277655,
  277552)
  / 100000)
m1.name <- 'Nug2020'
  
# Buy and hold
m2 <- (c(
  100000,102167,101148,104954,104596,106464,109457,109189,113982,112726,113661,
  115961,115055,115752,116749,116841,115832,111687,116129,117357,119319,114196,
  116876,124771,119143,120752,119089,122822,123513,127767,128429,128912,130704,
  132257,131149,125852,117218,110864,110072,108350,110660,114913,109523,117110,
  116199,109009, 92807,101331, 89035, 72285, 81227, 58686, 68452, 64347, 71846,
   69591, 76567, 90342, 87853, 96099, 91408, 94872, 91891, 84173, 81446, 78641,
   91214, 89257, 95798, 99303,101766,110794,112333,117113,122478,127497,117233,
  125479,126411,130563,133008,128226,133128,129798,125522,132781,138925,147061,
  152190,154348,161154,160540,158996,157583,162610,161226,163478,167786,168750,
  172802,164776,162037,164936,174520,178008,179567,177820,169183,170687,175890,
  174445,181624,169450,172950,184750,188192,190943,195343,197942,206174,207001,
  200771,207155,206381,203137,208912,217649,219559,220981,223545,232395,237718,
  234577,215227,216850,219246,214701,217331,231969,226901,227122,219834,216821,
  224404,221070,232312,239890,241099,251663,253789,251746,245862,234384,227057,
  218035,221381,229759,226472,233531,238749,237463,242673,240549,236545,239441,
  248279,245975,245607,249436,265190,263098,238505,227261,218522,227000,222241,
  216760,224177,227946,223709,220706,223829,231975,240697,232767,228840,240901,
  244915,247434,251663,260726,257070,265523,265031,274988,275087,284300,287584,
  296733,291533,285507,284623,284004,281342,271846,269197,274126,269626,276171,
  267056,264522,245281,243490,250813,271144,285123,297915,267585,256822,269925,
  270885,268921,268040,274390,273090,285215,292891,295400,291804,300102,308359,
  316047,310088,306441,313326,319238,320420,327566,316282,333442,336493,336736,
  341845,345518,356813,360768,366116,378535,367520,369092,348260,346078,349683,
  349936)
  / 100000) 
m2.name <- 'BuyNHold'

# Cash in Low
# Weekly: 20% from each of the top 3 to the bottom 3
# Top 3 to bottom 3
m3.raw <- c(
  100000,102167,101148,104997,104643,106512,109532,109273,114036,113137,114069,
  116533,115600,116629,117709,117537,116530,112346,116771,118249,120177,114836,
  118251,126889,121218,122903,120194,124930,125387,129023,129612,130082,131698,
  133080,131765,125728,116540,109486,108181,105522,108211,112645,106378,114355,
  114527,107128, 89729, 97876, 85064, 66918, 76808, 51192, 62377, 58594, 68147,
   64303, 70771, 86122, 83989, 92275, 87273, 91087, 87848, 78944, 79067, 75872,
   88593, 87259, 92578, 96700, 97747,106388,106722,111840,116500,120177,110892,
  119052,119489,123724,127317,122963,130146,125819,118416,126376,132915,138441,
  145101,151295,158583,152022,146388,146213,152866,160656,161174,168621,167971,
  172368,168456,167876,167727,175303,182217,185591,183887,175633,182563,190128,
  186845,193282,170844,177139,189729,195418,195787,201743,201655,208710,211954,
  198513,204383,199388,197815,203305,213103,215934,218241,215977,229185,237996,
  231580,212594,215976,226846,221993,225202,236009,230874,232101,226337,222152,
  229381,223895,233355,241667,241914,254279,258127,257429,256292,246095,242075,
  230474,235889,243793,237908,246734,253001,253349,257487,255880,254087,257666,
  266873,269487,273797,275189,287748,289991,256536,244044,235483,247478,241368,
  236578,249282,258355,257959,251783,252957,259510,270695,259093,252092,267413,
  273894,274710,281357,292992,286621,298929,303291,316057,320080,335039,335351,
  345412,340301,335331,338502,336186,331706,316295,318023,324408,313321,323428,
  306539,305709,277943,278420,290018,319934,343173,355555,331907,315358,330590,
  331573,333431,329279,340016,336066,352981,364412,373287,366017,376907,394238,
  401025,394598,388086,402245,417479,425033,453706,452553,512366,502733,503142,
  515997,521319,540084,552521,600010,614911,605379,604852,570585,541042,552285,
  553149)
m3 <- m3.raw / 100000
m3.name <- 'CashInLow'
len <- length(m3)
(last.week.gains <- m3.raw[len] - m3.raw[len - 7])
(per <- last.week.gains / 3)

# Cash in High
# Weekly: 20% from each of the bottom 3 to the top 3
# Bottom 3 to top 3
m4.raw <- c(
  100000,102167,101148,104915,104551,106395,109369,109038,113783,112160,113044,
  114144,114321,114541,115474,115630,114614,110599,115021,116023,117843,113001,
  115238,124139,117255,118919,117433,121331,121689,127019,127417,128672,130799,
  132530,130549,123879,114154,107205,107043,104999,107747,112900,107519,115578,
  115210,105664, 85810, 95771, 82057, 63528, 73094, 47958, 58974, 54513, 62795,
   61096, 67419, 82553, 79328, 87863, 82544, 86303, 83476, 75067, 71054, 68208,
   81204, 79001, 86621, 90142, 93180,102910,104915,108991,115398,121268,108346,
  117901,118249,123493,125943,120534,125771,122258,117356,126321,134099,144020,
  149051,151653,159970,163563,163197,160448,167895,164334,169115,175094,177320,
  183147,172181,166607,170403,184259,188195,191036,190443,178867,177289,185460,
  181908,192831,177515,183547,200818,205888,211584,219559,224505,241172,244562,
  236693,249062,248857,239568,254038,268596,271643,269902,276902,296715,308743,
  298774,255983,258728,258320,247832,252742,282967,272842,273249,256967,252135,
  268182,263905,287265,303079,310478,339260,342297,340417,315057,283302,270110,
  253873,258066,275145,269033,281391,289742,286931,301204,294881,286387,294750,
  307306,304435,302665,308458,338524,332012,287228,267763,254018,270582,260658,
  248871,264720,270346,260818,256856,262937,279436,294683,279452,272850,294098,
  299870,306443,313584,332292,326201,340842,340414,369620,365427,389735,393635,
  407404,396890,368997,360817,358321,353032,331928,327330,333853,323744,335305,
  316319,317037,285298,281516,296159,333916,358543,376295,314890,298903,323357,
  325966,321359,318037,326641,327171,346744,362740,365507,349671,364934,384504,
  397199,383605,381365,393960,404777,411141,427543,404284,435574,442071,446521,
  452680,462394,486523,492971,502031,533953,515718,515833,474305,471384,479142,
  466778)
m4 <- m4.raw / 100000
m4.name <- 'CashInHigh'
(last.week.gains <- m4.raw[len] - m4.raw[len - 7])
(per <- last.week.gains / 3)
  
# 30/70 
# Whenever a stock moves above 70, take out 20% to reserve
# Whenever a stock falls below 30 add 10% of reserves (or whatever fraction if > 4)
m5 <- (c(
  100000,102167,101148,104954,104596,106464,109457,109189,114077,112715,113592,
  115858,114989,115681,116638,116742,115758,111657,115989,117205,119175,114131,
  116824,124603,119075,120594,118838,122588,123279,127354,128016,128442,130083,
  131709,130491,125402,117110,111084,110211,108591,110738,115460,109079,117238,
  115851,108546, 91862,101632, 87836, 69423, 73424, 54978, 65562, 60769, 68782,
   65198, 71765, 87490, 85973, 94998, 89845, 94414, 91053, 82579, 80652, 77546,
   91356, 89473, 96219, 99585,101526,110948,112683,117628,122989,127628,116913,
  125506,126659,130513,132817,127701,133233,129950,124852,131469,137901,145821,
  151400,153390,160357,159078,156283,155164,159608,160018,161869,166097,166340,
  170208,163837,161937,165068,173494,176675,177973,176578,169140,172413,177272,
  175825,181533,169690,172715,182272,185553,187635,191054,192730,198425,198774,
  192755,197157,196267,194075,198181,204357,207219,205712,205507,214946,218711,
  217514,205021,206363,209937,206738,209102,219155,216232,216861,212642,209933,
  214586,212491,219530,225409,225986,232406,234226,231426,228828,221089,215580,
  209781,211937,217619,215064,220952,224790,223026,226792,225269,221716,222868,
  232283,233241,232466,235286,244788,246790,226818,217287,211179,217918,213903,
  209715,214690,219869,216856,214356,216039,221171,227100,220348,217621,227384,
  230899,232182,234930,241775,237679,243412,253706,258525,260519,266896,267516,
  272407,268684,265869,265140,264777,262884,257276,255429,259605,255507,261954,
  253368,252345,236638,234650,243746,260840,275789,275343,257405,245711,256024,
  257409,256409,257400,264723,262806,272082,277803,279533,276534,282732,288211,
  291733,287566,285039,289972,297073,296033,305080,295886,308507,309856,309577,
  313241,316561,326333,331543,335913,345940,339394,338377,322930,319266,322425,
  322676)
  / 100000)
# Currently pending:
m5.name <- '30/70'  


totin <- FidIn + f1kIn + OHIn
totval <- FidVal + f1kVal + OHVal
tot <- totval / totin
tot <- tot / tot[last]
minein <- FidIn + OHIn
mineval <- FidVal + OHVal
mine <- mineval / minein
mine <- mine / mine[last]
m1 <- m1 / m1[1]
m2 <- m2 / m2[1]
m3 <- m3 / m3[1]
m4 <- m4 / m4[1]
m5 <- m5 / m5[1]

# Calculate Sharpe Ratios
Sharpe <- function(returns, window=length(returns)) {
  if (length(returns) > window) {
    returns <- returns[(length(returns) - window):length(returns)]	  	
  }	
  returns <- returns[!is.na(returns)]
  (sqrt(252) * mean(returns)) / sd(returns)
}

get.daily.returns <- function(x) { 
  n <- length(x)
  x[2:n] / x[1:(n - 1)] - 1 
}

n <- length(m1) 
m <- length(SP)
this.year <- (m-n):m

SP.sh  <- round(Sharpe(get.daily.returns(SP[this.year])), 3)
tot.sh <- round(Sharpe(get.daily.returns(tot[this.year])), 3)
mine.sh <- round(Sharpe(get.daily.returns(mine[this.year])), 3)
m1.sh  <- round(Sharpe(get.daily.returns(m1)), 3)
m2.sh  <- round(Sharpe(get.daily.returns(m2)), 3)
m3.sh  <- round(Sharpe(get.daily.returns(m3)), 3)
m4.sh  <- round(Sharpe(get.daily.returns(m4)), 3)
m5.sh  <- round(Sharpe(get.daily.returns(m5)), 3)
prev <- m - n
days <- -prev:(n - 1)
new.days <- 0:(n - 1)
plot(new.days,
     m1, 
     type='l', 
     xlim=range(days),
     ylim=range(c(SP,  tot, 1 + tot - SP, mine, m1,  m2, m3, m4, m5)), 
     lwd=3, 
     log='y')
abline(h=seq(0, 8, 0.1), lty=2, col=rgb(0, 0, 0, 0.2))
abline(h=seq(0, 8, 0.5), lty=4, col=rgb(0, 0, 0, 0.8))
abline(v=0, lwd=2)
lines(days, tot, col=2, lwd=3)
lines(days, mine, col='cadetblue', lwd=3)
lines(days, SP, col='yellow', lwd=3)
lines(new.days, m2, lwd=3, col='coral')
lines(new.days, m3, lwd=3, col='blue')
lines(new.days, m4, lwd=3, col='purple')
lines(new.days, m5, lwd=3, col='cyan')
lines(days, 1 + tot - SP, col='#880000')
legend(
  'topleft', 
  lty=1, 
  lwd=c(3, 3, 3, 3, 3, 3, 3, 3, 1), 
  col=c('black', 'red ', 'cadetblue', 'yellow',  'coral', 'blue', 'purple', 
        'cyan', '#880000'),
  legend=c(paste(m1.sh, m1.name), 
           paste(tot.sh, 'Actual'), 
           paste(mine.sh, 'Mine'),
           paste(SP.sh, 'S&P'), 
           paste(m2.sh, m2.name), 
           paste(m3.sh, m3.name), 
           paste(m4.sh, m4.name), 
           paste(m5.sh, m5.name), 
           'Actual Diff'),
  bty='n')
  
quartz()  
plot(new.days,
     m1, 
     type='l', 
     xlim=range(days[days >= 0]),
     ylim=c(0.4, max(c(SP,  tot, 1 + tot - SP, mine, m1,  m2, m3, m4, m5))), 
     lwd=3, 
     log='y')
abline(h=seq(0, 8, 0.1), lty=2, col=rgb(0, 0, 0, 0.2))
abline(h=seq(0, 8, 0.5), lty=4, col=rgb(0, 0, 0, 0.8))
abline(v=0, lwd=2)
lines(days, tot, col=2, lwd=3)
lines(days, mine, col='cadetblue', lwd=3)
lines(days, SP, col='yellow', lwd=3)
lines(new.days, m2, lwd=3, col='coral')
lines(new.days, m3, lwd=3, col='blue')
lines(new.days, m4, lwd=3, col='purple')
lines(new.days, m5, lwd=3, col='cyan')
lines(days, 1 + tot - SP, col='#880000')
legend(
  'topleft', 
  lty=1, 
  lwd=c(3, 3, 3, 3, 3, 3, 3, 3, 1), 
  col=c('black', 'red ', 'cadetblue', 'yellow',  'coral', 'blue', 'purple', 
        'cyan', '#880000'),
  legend=c(paste(m1.sh, m1.name), 
           paste(tot.sh, 'Actual'), 
           paste(mine.sh, 'Mine'),
           paste(SP.sh, 'S&P'), 
           paste(m2.sh, m2.name), 
           paste(m3.sh, m3.name), 
           paste(m4.sh, m4.name), 
           paste(m5.sh, m5.name), 
           'Actual Diff'),
  bty='n')
  
# Downward vals only
sp.start <- which(SP == 1)
n.sp <- length(SP)
sp.rec <- SP[sp.start:n.sp]
n.sp <- length(sp.rec)
sp.ch <- sp.rec[2:n.sp] / sp.rec[1:(n.sp-1)]
m1.ch <- m1[2:n.sp] / m1[1:(n.sp-1)]
m2.ch <- m2[2:n.sp] / m2[1:(n.sp-1)]
m3.ch <- m3[2:n.sp] / m3[1:(n.sp-1)]
m4.ch <- m4[2:n.sp] / m4[1:(n.sp-1)]
m5.ch <- m5[2:n.sp] / m5[1:(n.sp-1)]
down.days <- which(sp.ch < 1)
up.days <- which(sp.ch > 1)
quartz()
plot(cumprod(c(1, sp.ch[down.days])), 
     type='l', 
     col='yellow', 
     ylim=c(0.05, 1), 
     log='y',
     lwd=2,
     main='Downward Days Only',
     ylab='Change')
lines(cumprod(c(1, m1.ch[down.days])), col='black', lwd=2)  
lines(cumprod(c(1, m2.ch[down.days])), col='coral', lwd=2)  
lines(cumprod(c(1, m3.ch[down.days])), col='blue', lwd=2)  
lines(cumprod(c(1, m4.ch[down.days])), col='purple', lwd=2)  
lines(cumprod(c(1, m5.ch[down.days])), col='cyan', lwd=2)  
legend('topright', 
       lty=1,
       lwd=2, 
       col=c('yellow', 'black', 'coral', 'blue', 'purple', 'cyan'),
       legend=c('SP', m1.name, m2.name, m3.name, m4.name, m5.name))
quartz()
plot(cumprod(c(1, sp.ch[up.days])), 
     type='l', 
     col='yellow', 
     ylim=c(1, 100), 
     log='y',
     lwd=2,
     main='Upward Days Only',
     ylab='Change')
lines(cumprod(c(1, m1.ch[up.days])), col='black', lwd=2)  
lines(cumprod(c(1, m2.ch[up.days])), col='coral', lwd=2)  
lines(cumprod(c(1, m3.ch[up.days])), col='blue', lwd=2)  
lines(cumprod(c(1, m4.ch[up.days])), col='purple', lwd=2)  
lines(cumprod(c(1, m5.ch[up.days])), col='cyan', lwd=2)  
legend('topleft', 
       lty=1,
       lwd=2, 
       col=c('yellow', 'black', 'coral', 'blue', 'purple', 'cyan'),
       legend=c('SP', m1.name, m2.name, m3.name, m4.name, m5.name))

# ______________________________________________________________________________


quartz()
x <- 1:length(totalFunds)
plot(x, 
     totalFunds, 
     type = 'l', 
     ylim=c(0, max(totalFunds)), 
     main='1 = 01 Jan 2018')#, log='y')
#savings.mod <- lm(totalFunds ~ x)

exp.mod <- function(funds, x) {
  savings.exp.mod <- lm(log(funds) ~ x)
  log.y <- coef(savings.exp.mod)[1] + x*coef(savings.exp.mod)[2]
  exp(log.y)  
}


#abline(savings.mod, col=rgb(0, 0, 0, 0.25))
start <- totalFunds[last]
now <- totalFunds[length(totalFunds)]
low <- min(totalFunds[(last):(length(totalFunds))])
high <- max(totalFunds)
earned <- high - start
down.from.high <- high - now
amt.down <- round(-100 *  down.from.high / earned, 2)
lines(x, exp.mod(totalFunds, x), col=rgb(0, 0, 0, 1))
abline(h=start, col='grey')
abline(h=now, col='grey')
abline(h=low, col=2)
abline(h=high, col=3)

lines(FidVal, col=4)
lines(x, exp.mod(FidVal, x), col=rgb(0, 0, 1, 1))

lines(f1kVal, col=5)
lines(x, exp.mod(f1kVal, x), col=rgb(0, 1, 1, 1))

lines(OHVal, col=6)
lines(x, exp.mod(OHVal, x), col=rgb(1, 0, 1, 1))

# FIX HERE
#amt.down <- round(100 * pct, 2)
amt.up <- round(100 * ((totalFunds[length(totalFunds)] / start) - 1), 2)
legend('topleft', 
       text.col=c('green', 'black', 'red'), 
       legend=c(sprintf('$%d', max(totalFunds)),
                sprintf('$%d\n(%.2f%% down\n  %.2f%% up)',
                        totalFunds[length(totalFunds)],
                        amt.down,
                        amt.up),
                sprintf('$%d', low)), 
       bg=rgb(1, 1, 1, 0.75))
legend('bottomright',
       lty=1,
       col=c(4, 5, 6, 1),
       legend=c('Fidelity', '401(k)', 'E*Trade', 'Total'),
       bg=rgb(1, 1, 1, 0.75))

day <- length(f1kIn) - 1 # length(<some new algo>) - 1
# Pad with leading NAs to make all vectors of equal length
tLength <- length(SP)
#Fid     <- c(rep(NA, tLength - length(Fid)),     Fid)
#OH      <- c(rep(NA, tLength - length(OH)),      OH)
#f1k     <- c(rep(NA, tLength - length(f1k)),     f1k)
days <- seq(to=day, by=1, length=tLength)

d <- data.frame(SP, Fid, OH, f1k)
realWts <- matrix(data=c(FidVal, OHVal, f1kVal), ncol=3)
realWts <- realWts / rowSums(realWts, na.rm = T)
realWts[is.na(realWts)] <- 0 
nWts <- length(realWts[, 1])
meanReal <- (Fid[(length(Fid) - nWts + 1):length(Fid)] * realWts[, 1] +
             OH[(length(OH)   - nWts + 1):length(OH)]  * realWts[, 2] +
             f1k[(length(OH)  - nWts + 1):length(f1k)] * realWts[, 3])
#meanReal <- c(rep(NA, 249), meanReal)
colors <- c(SP='yellow', Fid='red', OH='green', f1k='#cc0088', meanReal='grey')			   
quartz()
matplot(days, d, type = 'l', lty = 1, col = colors, 
		lwd = 2, main = 'Performance of Funds (2018)',
	  	xlab = 'Market Days Elapsed', ylab = 'Times Original Value', 
	  	log = 'y', 
	  	xlim = c(0, day + 5), 
	  	ylim = c(min(d[days >= 0, ], meanReal - SP + 1, na.rm=T), 
	  			 max(d[days >= 0, ], meanReal - SP + 1, na.rm=T)))
lines(days, (meanReal - SP) + 1, lwd=1)
lines(days, d[, 'SP'], col = 'yellow', lwd=3)
lines(days, meanReal, col = colors['meanReal'], lwd=1)

abline(h=1, lwd = 2)
abline(v=0, lwd = 2)
abline(v=last - 1)
#abline(v=c(30, 75), lty=4, col=rgb(0, 0, 0, 0.4))
abline(h=seq(0.1, 5.0, 0.1), col=rgb(0, 0, 0, 0.4), lty=2:1)

SP.Sharpe   <- round(Sharpe(SPd),  3)
Fid.Sharpe  <- round(Sharpe(Fidd), 3)
OH.Sharpe   <- round(Sharpe(OHd),  3)
f1k.Sharpe  <- round(Sharpe(f1kd), 3)
real.Sharpe <- round(Sharpe(dailyChange(meanReal)), 3)   

all.n <- length(SPd)
SP.Sharpe1yr   <- round(Sharpe(SPd[last:all.n],  250), 3)
Fid.Sharpe1yr  <- round(Sharpe(Fidd[last:all.n], 250), 3)
OH.Sharpe1yr   <- round(Sharpe(OHd[last:all.n],  250), 3)
f1k.Sharpe1yr  <- round(Sharpe(f1kd[last:all.n], 250), 3)
real.Sharpe1yr <- round(Sharpe(dailyChange(meanReal)[last:all.n], 250), 3)

legend(
  'topleft', 
  title='All data',
  legend=c(
    sprintf('%11s: %+.3f', 'SP500',  SP.Sharpe), 
    sprintf('%15s: %+.3f', 'Fid',    Fid.Sharpe), 
    sprintf('%13s: %+.3f', 'OH',     OH.Sharpe), 
    sprintf('%15s: %+.3f', 'f1k',    f1k.Sharpe), 
    sprintf('%s: %+.3f', 'meanReal', real.Sharpe),
    sprintf('%s', 'diff')),
  lty=1, 
  col=c(colors, 'black'), 
  lwd=c(2, 2, 2, 2, 1, 1), 
  bg=rgb(1, 1, 1, 0.8), 
  cex=0.6)
legend(
  'bottomleft', 
  title='Last year only',
  legend = c(
    sprintf('%11s: %+.3f', 'SP500',  SP.Sharpe1yr), 
    sprintf('%15s: %+.3f', 'Fid',    Fid.Sharpe1yr), 
    sprintf('%13s: %+.3f', 'OH',     OH.Sharpe1yr), 
    sprintf('%15s: %+.3f', 'f1k',    f1k.Sharpe1yr), 
    sprintf('%s: %+.3f', 'meanReal', real.Sharpe1yr),
    sprintf('%s', 'diff')),
  lty=1, 
  col=c(colors, 'black'), 
  lwd=c(2, 2, 2, 2, 2, 1, 1), 
  bg=rgb(1, 1, 1, 0.8), 
  cex=0.6)




#-------------------------------------------------------------
x <- 1:length(totalFunds)
savings.exp.mod <- lm(log(totalFunds) ~ x)
x <- last + seq(250, 3750, by=250)[1:10]
log.y <- coef(savings.exp.mod)[1] + x*coef(savings.exp.mod)[2]
y <- round(exp(log.y))
for (p in y) { cat(p, '\n') }
#-------------------------------------------------------------



#-------------------------------------------------------------
# weight by history length
f <- sqrt
w <- c(f(50), # nya 50
       f(35), # nya 35
       f(20), #     20...
       f(10), 
       f(5),
       f(3),  # nya 3
       f(50), # sp 50
       f(35), # sp 35
       f(20), #    20...
       f(10), 
       f(5),
       f(3))  # sp 3
(w <- w / sum(w))

# 0.0001 >= 0.00005 = 5e-5
# Mon
nya3 <- c(1, 0.2559, 0.9935)
sp3 <-  c(0.0001, 0, 0)

# Tue
nya5 <- c(1, 0.7099, 0.3730)
sp5 <-  c(0.0865, 0, 0)

# Wed    
nya10 <- c(0.9913, 0.1567, 1)
sp10 <-  c(0.0108, 0.9336, 0.0533)

# Thu
nya20 <- c(0.0228, 1, 1)
sp20 <-  c(0.0001, 1, 1)

# Fri
nya35 <- c(1, 1, 1)
sp35 <-  c(1, 1, 0.9912)

# Sat
nya50 <- c(0.1256, 1, 0.9922)
sp50 <-  c(1, 1, 1)


n <- length(wlsh.osc)
dif <- wlsh.osc[n] - wlsh.osc[n - 1]
if (dif == 0) { 
  cat('No change. Handle this case') 
} else { change <- ifelse(dif > 0, 'up', 'down') }
powET  <- ifelse(change == 'up', 2, 0)
powFid <- ifelse(change == 'up', 1, -0.1)

cat(
  sprintf('Direction is: %s\n  Set ET exp to %.2f and Fid exp to %.2f', 
          change, 
          powET, 
          powFid))

CASH_OUT
CASH_IN

(cash.out.fid <- CASH_OUT * FidVal[length(FidVal)])
cash.out.fid <- 12542 # Update ONLY when new threshold crossed

(cash.out.et <- CASH_OUT * OHVal[length(OHVal)])
cash.out.et <- 12479

# Change must be > 5% (10% for 401k)
# UPDATE: Fridays or when a percent-in value has changed
# Fid (buy and hold form Partnership Portfolio) [4-param]
(fid.amt <- FidVal[length(FidVal)]) # [59275, 98172]
(fid.pct.in <- w %*% c(nya50[1], nya35[1], nya20[1], nya10[1], nya5[1], nya3[1],
                       sp50[1],  sp35[1],  sp20[1],  sp10[1],  sp5[1],  sp3[1]))
(0.5536 - 0.5535) # 0.01
fid.amt.in <- fid.amt * fid.pct.in
(fid.res <- fid.amt - fid.amt.in)

# OH (e*trade) - traditional strategy [3-param]
(oh.amt <- OHVal[length(OHVal)]) # [50677, 94294]
(oh.pct.in <- w %*% c(nya50[2], nya35[2],  nya20[2], nya10[2], nya5[2], nya3[2],
                      sp50[2],  sp35[2],   sp20[2],  sp10[2],  sp5[2],  sp3[2])) 
(0.8214 - 0.8213) # 0.01
oh.amt.in <- oh.amt * oh.pct.in
(oh.res <- oh.amt - oh.amt.in)

# For 401(k): # 84.27 -- NEXT: 17 Dec (10% Change Required)
(f1k.total <- f1kVal[length(f1kVal)]) # 40585 [2-param]
(f1k.pct.in <- w %*% c(nya50[3], nya35[3], nya20[3], nya10[3], nya5[3], nya3[3],
                       sp50[3],  sp35[3],  sp20[3],  sp10[3],  sp5[3],  sp3[3])) 
(0.8275 - 0.8427) # 1.52
(f1k.res <- 1 - f1k.pct.in)
#--------------------------------------------------------

x <- c(1, 2, 4)
x <- x / sum(x)
x * c(f1k.pct.in)

#--------------------------------------------------------
# To Save New `df` at the end of each year:
df.test <- data.frame(
  SPActual=SPActual, FidIn=FidIn, FidVal=FidVal, f1kIn=f1kIn, f1kVal=f1kVal, 
  OHIn=OHIn, OHVal=OHVal)
matplot(df.test, type='l', lty=1, col=1:7)
legend('topleft', lty=1, col=1:7, legend=names(df.test))
# Backed up previous?
save(df.test, file='~/Desktop/marketStudies/data/myHistoricTest.RData')
rm(list=ls())
load('~/Desktop/marketStudies/data/myHistoricTest.RData')
ls()
matplot(df.test, type='l', lty=1, col=1:7)
legend('topleft', lty=1, col=1:7, legend=names(df.test))
# OK?
df <- df.test
save(df, file='~/Desktop/marketStudies/data/myHistoric.RData')
# Delete test and backups