#---------#---------#---------#---------#---------#---------#---------#---------
#install.packages('stringr')
library(stringr)

load('~/Learning/marketModeling/data/myHistoric.RData')
head(df)
tail(df)

get.daily.change <- function(x) {
  (x[2:length(x)] - x[1:(length(x) - 1)]) / x[1:(length(x) - 1)]
}


prev.last <- dim(df)[1]


sp.actual <- c(
  df$sp.actual,     4743,  4705,  4689,  4697,  4764,  4757,  4783,  4780,  4784,
      4766,  4739,  4781,  4840,  4850,  4865,  4869,  4894,  4891,  4928,  4925,
      4846,  4906,  4959,  4943,  4995,  4998,  5027,  5022,  4953,  5001,  5030,
      5006,  4976,  4982,  5087,  5089,  5070,  5078,  5070,  5096,  5137,  5131,
      5079,  5105,  5157,  5124,  5118,  5175,  5165,  5150,  5117,  5149,  5179,
      5225,  5242,  5234,  5218,  5204,  5248,  5254,  5244,  5206,  5211,  5147,
      5204,  5204,  5210,  5161,  5199,  5123,  5062,  5051,  5022,  4967,  5011,
      5071,  5072,  5048,  5100,  5116,  5036,  5018,  5064,  5128,  5181,  5188,
      5188,  5214,  5223,  5221,  5247,  5308,  5297,  5303,  5308,  5321,  5307,
      5268,  5305,  5306,  5267,  5235,  5278,  5283,  5291,  5354,  5353,  5347,
      5361,  5375,  5421,  5434,  5432,  5473,  5487,  5473,  5465,  5448,  5469,
      5478,  5483,  5460,  5475,  5509,  5537,  5567,  5573,  5577,  5634,  5585,
      5615,  5631,  5667,  5588,  5545,  5505,  5564,  5556,  5427,  5399,  5459,
      5464,  5436,  5522,  5447,  5347,  5186,  5240,  5200,  5319,  5344,  5344,
      5434,  5455,  5543,  5554,  5608,  5597,  5621,  5571,  5635,  5617,  5628,
      5592,  5592,  5648,  5529,  5520,  5503,  5408,  5471,  5496,  5554,  5596,
      5626)

fid.in <- c(
  df$fid.in,      167137,167137,167137,167137,167137,167137,167137,167137,167137,
    167137,167137,167137,167137,167137,167137,167137,167137,167137,167137,167743,
    167743,167743,167743,167743,167743,167743,167743,167743,167743,168118,168118,
    168118,168118,168118,168118,168118,168118,168118,168659,168659,168659,168659,
    168659,168659,168659,168659,168659,168659,168659,169043,169043,169043,169043,
    169043,169043,169043,169043,169043,169043,169043,169043,169043,169043,169043,
    169043,169043,169043,169043,169043,170902,170902,170902,170902,171989,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,172299,
    172299) #
fid.val <- c(
  df$fid.val,     226255,222123,222288,222370,226164,226085,226787,226918,226111,
    224232,223153,225424,226784,228372,228427,227347,228082,228542,230917,229343,
    226581,228977,229117,227482,230179,230329,232353,233160,228934,231689,233479,
    232492,230514,228486,229981,230323,230887,232613,232499,233201,234712,233701,
    230947,232421,234109,233753,234290,234691,234813,233187,232082,233053,233367,
    234789,234401,233398,233032,232857,234877,235694,234961,232672,232286,229956,
    230974,232520,235543,232113,232328,229986,225289,224961,223670,217831,220209,
    224858,225305,224032,224974,226345,222858,222309,225158,227389,229245,228731,
    227183,229108,228380,230280,232608,236093,234594,235648,239119,234184,233741,
    233665,235810,237047,235273,236550,235337,235018,230413,232918,235235,233328,
    233689,231503,233423,227740,227824,230174,229505,230017,231881,232306,232427,
    232366,233366,233117,232227,230614,231987,231919,230881,230238,229711,233017,
    235110,235205,239054,234494,231546,230246,230682,231413,226668,226906,230349,
    230492,231121,234023,230335,227764,223875,226465,227110,231277,230029,229028,
    233444,233421,238544,239255,241329,240493,242784,240301,242395,241522,242164,
    239755,240766,243615,239662,239450,237906,233578,235493,236402,239230,241248,
    242405) #

f1k.in <- c(
  df$f1k.in,       36528, 36528, 36528, 36528, 36528, 36528, 36528, 36528, 36528,
     36528, 36528, 36528, 37334, 37334, 37334, 37334, 37334, 37334, 37334, 37334,
     37344, 37344, 37344, 37344, 37344, 38125, 38125, 38125, 38125, 38125, 38125,
     38125, 38125, 38125, 38125, 38878, 38878, 38878, 38878, 38878, 38878, 38878,
     38878, 38878, 39644, 39644, 39644, 39644, 39644, 39644, 39644, 39644, 39644,
     39644, 40401, 40401, 40401, 40401, 40401, 40401, 40401, 40401, 40401, 41156,
     41156, 41156, 41156, 41156, 41156, 41156, 41156, 41156, 41156, 41938, 41938,
     41938, 41938, 41938, 41938, 41938, 41938, 41938, 42720, 42720, 42720, 42720,
     42720, 42720, 42720, 42720, 42720, 42720, 43468, 43468, 43468, 43468, 43468,
     43468, 43468, 43468, 43468, 43468, 43468, 43468, 43468, 43468, 44218, 44218,
     44218, 44218, 44218, 44218, 44218, 44218, 44218, 44218, 44950, 44950, 44950,
     44950, 44950, 44950, 44950, 44950, 44950, 45676, 45676, 45676, 45676, 45676,
     45676, 45676, 45676, 45676, 46377, 46377, 46377, 46377, 46377, 46377, 46377,
     46377, 46377, 46377, 47106, 47106, 47106, 47106, 47106, 47106, 47106, 47106,
     47106, 47106, 47106, 47106, 47106, 47106, 47106, 47106, 47822, 47822, 47822,
     47822, 47822, 47822, 47822, 47822, 47822, 48548, 48548, 48548, 48548, 48548,
     48548) # (1062.63)
f1k.val <- c(
  df$f1k.val,      48986, 48283, 47658, 47523, 47500, 48441, 48481, 48834, 48889,
     48787, 48421, 48149, 49621, 50044, 50275, 50379, 50236, 50386, 50377, 50840,
     50612, 49913, 50474, 50514, 50799, 52134, 52198, 52505, 52658, 51770, 52377,
     52829, 52634, 52248, 52172, 53963, 53967, 53910, 54156, 53976, 54138, 54604,
     54507, 53928, 55347, 55884, 55505, 55488, 55855, 55779, 55440, 55196, 55422,
     55642, 57178, 57367, 57156, 57078, 56963, 57499, 57586, 57417, 56874, 57990,
     57334, 57804, 57908, 58222, 57548, 57843, 56879, 56042, 55903, 56430, 55899,
     56370, 57153, 57229, 57020, 57613, 57942, 57016, 57902, 58548, 59218, 59844,
     59960, 59764, 60095, 60165, 60311, 60699, 62436, 62301, 62358, 62481, 62390,
     61889, 61717, 62183, 62127, 61562, 61378, 61676, 61604, 61604, 63317, 63323,
     63100, 63271, 63350, 63081, 63815, 63699, 64206, 64207, 65114, 65157, 65065,
     65200, 65382, 65531, 65306, 65381, 65768, 67135, 67401, 67414, 67279, 67839,
     67798, 68261, 68458, 69204, 69290, 68561, 68195, 68956, 68973, 67337, 67151,
     67821, 67816, 67574, 69644, 68506, 67126, 65277, 65948, 65475, 67067, 67623,
     68121, 68427, 68508, 69791, 69924, 69924, 69924, 69924, 71138, 72082, 71820,
     71897, 71349, 71410, 72031, 70349, 70070, 70902, 69628, 70303, 70603, 71455,
     72048) #

self.mng.in <- c(
  df$self.mng.in,  13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857, 13857,
     13857)  #
self.mng.val <- c(
  df$self.mng.val, 16169, 15852, 15887, 15861, 16152, 16065, 16106, 16048, 15949,
     15728, 15640, 15791, 15827, 15929, 15951, 15813, 15829, 15851, 16031, 15841,
     15676, 15823, 15793, 15725, 15939, 15910, 16011, 16149, 15794, 16015, 16214,
     16157, 15990, 15865, 15916, 15896, 15920, 16087, 15971, 15955, 16085, 16009,
     15835, 15960, 16084, 16004, 16053, 16062, 16076, 15888, 15863, 15899, 15900,
     15997, 15993, 15896, 15924, 15877, 16054, 16109, 16046, 15858, 15851, 15735,
     15738, 15820, 16075, 15819, 15821, 15497, 15176, 15092, 14957, 14775, 14890,
     15136, 15205, 15126, 15293, 15480, 15259, 15239, 15511, 15673, 15807, 15858,
     15701, 15785, 15790, 15955, 16086, 16216, 16193, 16196, 16218, 16085, 16077,
     15906, 16049, 16022, 15855, 15928, 15950, 15863, 15755, 15885, 15935, 15811,
     15824, 15765, 15871, 15692, 15628, 15752, 15667, 15680, 15779, 15824, 15758,
     15865, 15948, 15876, 15854, 15957, 16014, 16002, 15970, 15868, 15934, 16247,
     16389, 16428, 16774, 16718, 16473, 16424, 16539, 16587, 16302, 16361, 16530,
     16488, 16492, 16625, 16299, 15946, 15616, 15772, 15698, 16035, 15978, 15949,
     16256, 16170, 16522, 16561, 16709, 16617, 16778, 16584, 16835, 16787, 16765,
     16615, 16715, 16856, 16483, 16358, 16255, 15963, 16062, 16132, 16279, 16410,
     16619)  #

et.in <- c(
  df$et.in,        86278, 86278, 86278, 86278, 86278, 86278, 86278, 86278, 86588,
     86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588,
     86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588,
     86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588,
     86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588,
     86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588,
     86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 86588, 87077,
     87077, 87077, 87077, 87077, 87125, 87125, 87125, 87125, 87125, 87125, 87125,
     87125, 87125, 87125, 87125, 87394, 87394, 87394, 87394, 87394, 87394, 87394,
     87394, 87394, 87394, 87394, 87489, 87489, 87489, 87489, 87489, 87489, 87489,
     87489, 87489, 87489, 88109, 88109, 88109, 88109, 88109, 88109, 88109, 88109,
     88109, 88630, 88630, 88630, 88630, 88630, 88630, 88630, 88630, 88630, 88630,
     88630, 88630, 88630, 88630, 88630, 88630, 88630, 88630, 88630, 88739, 88739,
     88739, 89028, 89028, 89028, 89028, 89254, 89254, 89254, 89254, 89254, 89254,
     89254, 89254, 89254, 89555, 89555, 89555, 89555, 89555, 89555, 89555, 89555,
     89555, 89877, 89877, 89877, 89877, 89877, 89877, 89877, 89877, 89877, 90050,
     90050) #
et.val <-c(
  df$et.val,      182169,178447,178828,178839,181753,181913,181774,181776,181803,
    179567,178132,180171,181513,182917,183106,181365,181575,181724,184209,180940,
    178873,179782,180339,178199,180807,180861,182226,184216,179375,180588,182490,
    182353,180259,177991,177930,178281,178744,181243,180251,180780,181437,180459,
    177915,179389,180992,181081,181587,181473,182144,180261,179555,180248,180442,
    182342,181731,180843,180198,180135,182084,182768,181906,179090,178802,176744,
    178034,179100,182201,178868,179892,175708,171620,171045,169258,167274,170315,
    174774,175161,173555,175121,176185,173538,173590,175874,178244,179937,179097,
    176517,178393,177761,178973,181929,184826,183913,184471,183928,181289,180603,
    177547,178201,177126,177001,175183,172249,172429,172345,174212,175113,173222,
    172757,172701,173560,170635,170735,170638,168853,169118,171110,170788,169940,
    171561,174805,174790,174299,174766,175089,176173,175317,174047,173920,176449,
    179340,179332,183045,182234,179218,178311,178534,179360,176146,176346,179651,
    179820,181277,183210,180633,176273,174758,176789,178243,181266,179645,178318,
    181194,181436,185868,187380,189190,188413,190704,188337,189743,189038,189107,
    187039,189394,192005,188574,187952,186736,183095,183956,184449,187008,188777,
    190097) #

sim1 <- (c(
           100000,100023, 99980, 99994, 99987,100290,100240,100401,100414,100410,
    100359,100355,100424,100650,100768,101019,100920,100574,100565,100971,100627,
    100108,100333,100273, 99800,101074,100928,101547,101921,100440,101730,102600,
    102332,101296,101151,101470,101600,102357,102763,102291,102912,103426,102585,
    101215,101635,102451,102399,103217,103459,103339,102972,102082,102398,102738,
    103257,102868,102540,102360,102660,103013,103286,102430,100591,100223, 99133,
     99612,100129,101217, 99542,100043, 98589, 97167, 97743, 97719, 97608, 98169,
     99191, 99400, 99387,100031, 99257, 97828, 98185, 99118, 99744,100304,101191,
    100247,100114,100122,100199,100338,101076,100894,100912,101130,100077,100505,
     99518, 99940, 99232, 99026, 98898, 99752, 99289, 99637, 99734,101415,100881,
    101520,102060,101842, 99875,100216,100370, 99356,101174,102452,102156,101286,
    102270,103837,104391,104463,104000,104561,104487,103827,102606,101986,102776,
    103965,104274,105646,104637,103879,103288,104311,104516,102518,103300,104534,
    103929,104266,105237,103533,101957, 99949,101244,100744,102747,102785,102515,
    103921,104129,105545,105539,106235,105889,106621,106159,107356,106871,107137,
    106449,106921,107618,105116,105004,104264,102756,103738,104052,104652,105551,
    106609)
  / 100000)
sim1.res <- 7286
mw <- read.csv('~/Downloads/Holdings - Damian Satterthwaite-Phillips.csv')
mw$Value <- str_replace(mw$Value, ",", "")
mw$Value <- as.numeric(str_replace(mw$Value, "\\$", ""))
sim1.val <- sum(mw$Value)
sim1.name <- 'adelaide'

sim2 <- (c(
           100000,100005, 99939, 99944, 99916,100348,100284,100473,100482,100456,
    100392,100352,100383,100598,100832,100945,100791,100552,100503,101031,100791,
    100206,100550,100560,100109,101389,101192,102098,102439,100607,102165,103874,
    102491,100794,100195,100399,101222,102244,102900,102483,103478,104332,103019,
    100497,100607,102200,102401,103780,104232,103814,102775,100948,102132,102489,
    103814,103012,102045,101976,102074,103215,103715,102167, 99869, 98982, 97437,
     98546, 99405,102131, 98578,100229, 97546, 94790, 95279, 94975, 94464, 95823,
     98994, 99690, 98507, 98996, 97989, 95867, 96738, 98294, 99758,101004,102440,
    101111, 98406, 98202, 98586, 99017,100311, 99984,100143,100661, 98356, 98794,
     96284, 97425, 96348, 95953, 95463, 97040, 96033, 96860, 97794,100670, 99555,
    100833,101781,102773, 99428,100766,101502,100466,101944,104281,103707,102325,
    103812,106750,107380,107106,106548,107482,107795,106485,103984,103237,106358,
    108612,109034,114518,112262,108384,105341,108150,109773,105470,106201,113000,
    111472,116798,120334,116236,112745,109882,111628,110277,115633,113297,112505,
    115859,116573,120231,117255,119710,117911,119154,118234,120015,118798,120068,
    118813,120119,121695,116871,117312,116047,112157,114444,115310,116106,118469,
    120988)
  / 100000)
sim2.res <- 21104
mw <- read.csv('~/Downloads/Holdings - Damian Satterthwaite-Phillips(1).csv')
mw$Value <- str_replace(mw$Value, ",", "")
mw$Value <- as.numeric(str_replace(mw$Value, "\\$", ""))
sim2.val <- sum(mw$Value)
sim2.name <- 'aei'

extr <- (c(
	                                                 rep(NA, 129), 100000,100396,
    100678,100494,100666,100437,100358, 98689, 98696, 99736, 97676, 97695, 97824,
     98220, 96418, 96543, 93702, 91196, 90755, 92744, 90577, 95241, 95138, 95801,
     98626, 99535,105849,106528,110364,108064,110433,107183,110462,108718,108727,
    107217,107172,109095,103211, 98714, 97449, 92219, 93053, 92713, 96043, 97845,
    100072)
  / 100000)
idx.only <- (c(
	                                                 rep(NA, 129), 100000, 99866,
     99970,101426,101818,100279, 98481, 97567, 98504, 99147, 96220, 93994, 94906,
     95447, 94981, 96484, 95792, 92730, 88453, 88016, 87403, 89615, 91371, 91989,
     94934, 95197, 97158, 98827, 99831,100352,100598, 99011,100292,100532,100338,
     99567, 99274,100223, 98000, 96520, 96587, 94108, 94689, 95660, 97504,100335,
    101101)
  / 100000)
  

sim3 <- (c(
           100000, 99994, 99910, 99915, 99882,100396,100317,100507,100498,100453,
    100374,100335,100273,100497,100651,100707,100672,100509,100488,100950,100587,
     99954,100323,100221, 99203,101861,102350,104026,105067,101967,104043,105629,
    105469,103711,103575,103878,104230,105505,106520,106100,106887,107357,105897,
    104068,103945,105697,105423,106596,106857,106916,105856,104180,105195,105630,
    106709,106494,105736,105307,105491,106508,107811,106402,104348,103418,101678,
    102593,104066,106228,102651,103149,100094, 96791, 97043, 96809, 96471, 98716,
    100489,101338,100515, 99660, 98712, 96340, 96238, 97956, 99296,100699,101839,
    100339, 98983, 99250, 99136, 99658,101156,101057,101026,101527,100109,101115,
     98708,100040, 98163, 97866, 98362,100012, 98239, 99868,101276,104388,103052,
    103812,105130,105306,102299,102601,102777,102023,105015,107270,107207,105619,
    106646,108907,108579,108509,107591,108200,108420,106950,104800,104430,107701,
    110157,110549,116307,114002,111350,108050,110587,111804,107485,108187,114465,
    113342,118055,121977,117278,113981,110631,112268,110201,115378,114264,113756,
    117984,118883,123290,121489,124259,122065,123691,121056,123951,122618,122979,
    120141,122111,124213,115384,114956,114148,109322,110563,113372,115266,117206,
    119276)
  / 100000)
sim3.res <- 18203
mw <- read.csv('~/Downloads/Holdings - Damian Satterthwaite-Phillips(2).csv')
mw$Value <- str_replace(mw$Value, ",", "")
mw$Value <- as.numeric(str_replace(mw$Value, "\\$", ""))
sim3.val <- sum(mw$Value)
sim3.name <- 'simsims'


sim4 <- (c(
                  rep(NA, 113), 100000,100225,100390,100055,100293,100283, 99426,
     99085, 99915, 98831, 98265, 99776,100092,101516,100984, 99546,100681,101588,
    102540,103044,104648,102637,101417, 99866,100512,101333, 96173, 95937, 98692,
     97515, 96021, 98963, 94534, 90575, 87070, 88895, 87692, 91417, 91140, 90632,
     92971, 94549, 98680, 97927, 99444, 99011,100642, 98884,100443, 99175, 98849,
     97547, 98201, 99870, 95460, 92908, 91754, 88582, 90112, 91465, 93771, 94829,
     96954)
  / 100000)
sim4.res <- 17857
mw <- read.csv('~/Downloads/Holdings - Damian Satterthwaite-Phillips(3).csv')
mw$Value <- str_replace(mw$Value, ",", "")
mw$Value <- as.numeric(str_replace(mw$Value, "\\$", ""))
sim4.val <- sum(mw$Value)
sim4.name <- 'sim3'

sim5 <- (c(
                  rep(NA, 113), 100000,100156,100060, 99956,101099,101930, 99023,
    101717,104187,104871,101874,100974,100786,101049,100762, 98699, 97620,103239,
    105116,107380,112545,113141,109772,101238, 99786,101674, 97366,100956,106313,
    105346,104116,106826,100338, 95865, 90840, 92163, 91706, 95009, 90574, 90877,
     93524, 93389, 96608, 96103, 97641, 96606, 98084, 96241, 98371, 96969, 97262,
     96025, 98169, 99717, 92128, 91695, 90781, 87972, 89537, 91203, 93125, 94487,
     96082)
  / 100000)
sim5.res <- 17222
mw <- read.csv('~/Downloads/Holdings - Damian Satterthwaite-Phillips(4).csv')
mw$Value <- str_replace(mw$Value, ",", "")
mw$Value <- as.numeric(str_replace(mw$Value, "\\$", ""))
sim5.val <- sum(mw$Value)
sim5.name <- 'simz'


normalize.to.index <- function(x, index) {
	x / x[index]
}


sp <- normalize.to.index(sp.actual, prev.last)
spd <- get.daily.change(sp)
fid <- fid.val / fid.in
fid <- normalize.to.index(fid, prev.last)
fidd <- get.daily.change(fid)
f1k <- f1k.val / f1k.in
f1k <- normalize.to.index(f1k, prev.last)
self.mng <- self.mng.val / self.mng.in
self.mng <- normalize.to.index(self.mng, prev.last)
self.mng.d <- get.daily.change(self.mng)
et <- et.val / et.in
et <- normalize.to.index(et, prev.last)
etd <- get.daily.change(et)
tot.in <- fid.in + f1k.in + et.in
tot.val <- fid.val + f1k.val + et.val
tot <- tot.val / tot.in
tot <- normalize.to.index(tot, prev.last)
mine.in <- fid.in + et.in + self.mng.in
mine.val <- fid.val + et.val + self.mng.val
mine <- mine.val / mine.in
mine <- normalize.to.index(mine, prev.last)

# Calculate Sharpe Ratios
get.sharpe.ratio <- function(returns, window=length(returns), rnd=3, ignore0=F) {
  if (length(returns) > window) {
    returns <- returns[(length(returns) - window):length(returns)]	  	
  }	
  returns <- returns[!is.na(returns)]
  if (ignore0) {
  	retruns <- returns[returns != 0]
  }
  round((sqrt(252) * mean(returns)) / sd(returns), rnd)
}


get.daily.returns <- function(x) { 
  n <- length(x)
  x[2:n] / x[1:(n - 1)] - 1 
}

get.sharpe.from.daily.values <- function(x, rnd=3, ignore0=F) {
  x <- x[!is.na(x)]
  get.sharpe.ratio(get.daily.returns(x), rnd=rnd, ignore0=ignore0)
}



m <- length(sp)
n <- length(sp) - prev.last
prev <- m - n
this.year <- (prev):m
days <- -prev:(n - 1) + 1
new.days <- 0:(n - 1)
year.start <- length(tot) - length(new.days)

sp.sh       <- get.sharpe.from.daily.values(sp[this.year])
self.mng.sh <- get.sharpe.from.daily.values(self.mng[this.year], ignore0=T)
tot.sh      <- get.sharpe.from.daily.values(tot[this.year])
mine.sh     <- get.sharpe.from.daily.values(mine[this.year])
f1k.sh      <- get.sharpe.from.daily.values(f1k[this.year]) 
fid.sh      <- get.sharpe.from.daily.values(fid[this.year]) 
et.sh       <- get.sharpe.from.daily.values(et[this.year])
sim1.sh     <- get.sharpe.from.daily.values(sim1)
sim2.sh     <- get.sharpe.from.daily.values(sim2)
sim3.sh     <- get.sharpe.from.daily.values(sim3)
sim4.sh     <- get.sharpe.from.daily.values(sim4)
sim5.sh     <- get.sharpe.from.daily.values(sim5)
extr.sh     <- get.sharpe.from.daily.values(extr)
idx.only.sh <- get.sharpe.from.daily.values(idx.only)


# PLOT 1: This year's returns ---------------------------------------------------
plot(
  days, 
  sp / sp[year.start], 
  type='l', 
  col='orange',
  lwd=3, 
  xlim=range(days[days >= 0]), 
  ylim=c(0.7, 1.3),
  log='y')
abline(h=seq(0, 8, 0.1), lty=2, col=rgb(0, 0, 0, 0.2))
abline(h=seq(0, 8, 0.5), lty=4, col=rgb(0, 0, 0, 0.8))
abline(v=0, lwd=2)
lines(days, tot / tot[year.start], lwd=3)
lines(days, mine / mine[year.start], col='cadetblue', lwd=3)
lines(days, fid / fid[year.start], col='darkgreen', lwd=3)
lines(days, et / et[year.start], col='purple', lwd=3)
lines(days, self.mng, col='sienna', lwd=3)
lines(days, f1k / f1k[year.start], lwd=3, col='maroon')
lines(0:(length(sim1) - 1), sim1, lwd=3, col='hotpink')
lines(0:(length(sim2) - 1), sim2, lwd=3, col='limegreen')
lines(0:(length(sim3) - 1), sim3, lwd=3, col='cyan')
lines(0:(length(sim4) - 1), sim4, lwd=3, col='burlywood4')
lines(0:(length(sim5) - 1), sim5, lwd=3, col='coral')
lines(0:(length(extr) - 1), extr, lwd=2, col='green')
lines(0:(length(idx.only) - 1), idx.only, lwd=2, col='blue')
lines(days, (1 + tot - sp) / (1 + tot - sp)[year.start], col=2)
legend(
  'topleft',
  lty=1,
  lwd=c(3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1),
  col=c(
    'orange', 'darkgreen', 'purple', 'sienna', 'maroon', 'cadetblue', 'black', 
    'hotpink', 'limegreen', 'cyan', 'burlywood4', 'coral', 'green', 'blue', 'red'),
  legend=c(
    paste(sp.sh, 'S&P'),
    paste(fid.sh, 'Fid'),
    paste(et.sh, 'ETrade'),
    paste(self.mng.sh, 'Self-Managed'),
    paste(f1k.sh, '401(k) All'),
    paste(mine.sh, 'Mine'),
    paste(tot.sh, 'Total'),
    paste(sim1.sh, sim1.name),
    paste(sim2.sh, sim2.name),
    paste(sim3.sh, sim3.name),
    paste(sim4.sh, sim4.name),
    paste(sim5.sh, sim5.name),
    paste(extr.sh, 'extrema'),
    paste(idx.only.sh, 'idx funds'),
    paste('Diff(SP)')),
  bg=rgb(1, 1, 1, alpha=0.8))
#--------------------------------------------------------------------------------


exp.mod <- function(funds, x) {
  savings.exp.mod <- lm(log(funds) ~ x)
  log.y <- coef(savings.exp.mod)[1] + x*coef(savings.exp.mod)[2]
  exp(log.y)  
}


start <- tot.val[prev.last]
now <- tot.val[length(tot.val)]
low <- min(tot.val[(prev.last):(length(tot.val))])
high <- max(tot.val[(prev.last):(length(tot.val))])


# PLOT 2: Total funds over time --------------------------------------------------
quartz()
x <- 1:length(tot.val)
plot(
  x, 
  tot.val, 
  type='l', 
  ylim=c(0, max(tot.val)), 
  main='1 = 01 Jan 2018')#, log='y')
lines(x, exp.mod(tot.val, x), col=rgb(0, 0, 0, 1))
abline(h=start, col='grey')
abline(h=now, col='grey')
abline(h=low, col=2)
abline(h=high, col=3)
old.f1k.val <- f1k.val
old.f1k.val[790:length(f1k.val)] <- 0
lines(fid.val + old.f1k.val, col=4)
lines(x, exp.mod(fid.val + old.f1k.val, x), col=rgb(0, 0, 1, 1))
lines(f1k.val[790:length(f1k.val)], col=5)
lines(
  x[790:length(f1k.val) - 789], 
  exp.mod(f1k.val[790:length(f1k.val)], x[790:length(f1k.val)]), 
  col=rgb(0, 1, 1, 1))
lines(et.val, col=6)
lines(x, exp.mod(et.val, x), col=rgb(1, 0, 1, 1))
smv <- self.mng.val[self.mng.val > 1]
x <- 1:length(smv)
lines(smv, col='sienna')
lines(x, exp.mod(smv, x), col='sienna')
legend(
  'topleft',
  lty=1,
  col=c('black', 'blue', 'magenta', 'cyan', 'sienna'),
  legend=c(
    paste('Total: ', tot.val[length(tot.val)]),
    'Fidelity', 
    'ETrade', 
    '401(k)', 
    'Self-Managed'),
  bg='white')
#---------------------------------------------------------------------------------


x <- 1:length(tot.val)
savings.exp.mod <- lm(log(tot.val) ~ x)
x <- prev.last + seq(250, 3750, by=250)[1:13]
log.y <- coef(savings.exp.mod)[1] + x*coef(savings.exp.mod)[2]
y <- round(exp(log.y))
for (p in y) { cat(p, '\n') }

(fid.amt <- fid.val[length(fid.val)])                # [179159 217844]
(et.amt <- et.val[length(et.val)])                   # [130010 154288]
(f1k.total <- f1k.val[length(f1k.val)])              # [ 18063  41548] 
(self.mng.amt <- self.mng.val[length(self.mng.val)]) # [  9514  16089]
(round(sim1.val) + (sim1.res))
(round(sim2.val) + (sim2.res))
(round(sim3.val) + (sim3.res))
(round(sim4.val) + (sim4.res))
(round(sim5.val) + (sim5.res))
(pct.invested)

n <- length(sim1)
NDAYS.LOOKBACK <- 5
sim1[n] / sim1[n - NDAYS.LOOKBACK]
sim2[n] / sim2[n - NDAYS.LOOKBACK]
sim3[n] / sim3[n - NDAYS.LOOKBACK]
sim4[n] / sim4[n - NDAYS.LOOKBACK]
sim5[n] / sim5[n - NDAYS.LOOKBACK]

n <- length(fid.val)
fid.val[n] / fid.val[n - NDAYS.LOOKBACK]
n <- length(et.val)
et.val[n] / et.val[n - NDAYS.LOOKBACK]
n <- length(self.mng.val)
self.mng.val[n] / self.mng.val[n - NDAYS.LOOKBACK]


# Perf:    1st 2nd 3rd  Pts(3x2x1)
# sim1       4   3   5   22
# fid        2   4   1   17
# et         5   6   0   27
# self.mng   3   1   5   16


#--------------------------------------------------------
# To Save New `df` at the end of each year:
#df.test <- data.frame(
#  sp.actual=sp.actual, fid.in=fid.in, fid.val=fid.val, f1k.in=f1k.in, 
#  f1k.val=f1k.val, et.in=et.in, et.val=et.val, self.mng.in=self.mng.in, 
#  self.mng.val=self.mng.val)
#matplot(df.test, type='l', lty=1, col=1:7)
#legend('topleft', lty=1, col=1:7, legend=names(df.test))
# Backed up previous?
#save(df.test, file='~/Learning/marketModeling/data/myHistoricTest.RData')
#rm(list=ls())
#load('~/Learning/marketModeling/data/myHistoricTest.RData')
#ls()
#matplot(df.test, type='l', lty=1, col=1:7)
#legend('topleft', lty=1, col=1:7, legend=names(df.test))
# OK?
#df <- df.test
#save(df, file='~/Learning/marketModeling/data/myHistoric.RData')
# Delete test and backups
