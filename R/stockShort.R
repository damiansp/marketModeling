#---------#---------#---------#---------#---------#---------#---------#---------
# Water stocks: cwt wtr awr awk artna  |->  sjw ctws msex yorw
rm(list = ls())
source('~/Desktop/marketStudies/R/stocks.R')

RSI <- 43.86

macdHisto <- c(
    3.782,  6.377,  9.308, 16.567, 18.394, 18.390, 20.373, 23.589, 23.405, 
   26.096, 26.233, 27.026, 29.768, 31.375, 31.000, 29.721, 32.500, 30.289, 
   22.920, 16.886, 11.479, -1.823,-28.078,-39.360,-50.000,-68.772,-75.782,
  -73.617,-69.389,-59.611,-46.657,-36.438,-30.885,-28.593,-26.069,-17.494,
   -6.532, -4.084, -6.950,-14.287,-17.274,-14.774,-11.789, -9.786, -6.551,
    2.637,  8.259,  9.156,  6.994,  4.750,  3.506, -3.401, -7.778,-11.580,
  -24.113,-40.528,-40.813,-46.780,-50.941,-47.350,-52.285,-49.649,-42.113,
  -33.111,-34.508,-33.329,-25.251,-21.096,-14.463,-10.586, -4.469,  4.072,
   10.227, 11.941,  9.404,  7.341,  0.421, -3.777, -2.633, -1.374, -2.227,
   -4.444, -6.302,-10.312, -7.168, -3.461, -0.911, 12.059, 17.552, 21.213,
   20.402, 20.817, 20.123, 17.958, 18.795, 17.521, 17.346, 15.837, 13.301,
    5.451,  6.363,  3.276,  5.204,  8.087, 10.047, 14.464, 16.741, 19.007,
   20.366, 21.319, 19.607, 18.714, 16.996, 14.293, 10.204,  7.578,  2.788,
   -0.069, -7.770,-12.241,-18.625,-20.301,-20.767,-19.448,-20.102,-16.722,
  -10.632, -2.646,  4.300,  6.015, 10.463, 13.591, 14.843, 16.788, 18.420,
   17.269, 15.434, 14.308, 14.915, 18.502, 10.056, 16.006, 10.864,  8.770,
    6.434,  6.445,  7.991, 10.115, 12.289, 13.146, 12.563,  8.618,  3.735,
    2.626, -1.604, -1.483, -0.201,  1.489,  3.268,  4.031,  3.518,  5.421,
    9.596, 12.131, 15.747, 15.711, 15.059, 13.232, 10.143,  5.899,  1.573,
   -0.963, -1.400, -1.777, -0.021,  1.065, -0.831, -0.128,  0.640,  4.231,
    6.207,  5.648,  4.277,  1.530,  0.472, -0.552,  0.029, -0.001,  0.013,
   -3.738, -8.870,-12.645,-15.794,-31.650,-50.488,-56.832,-62.293,-55.933,
  -50.206,-50.872,-50.212,-50.221,-51.162,-62.857,-62.137,-66.814,-70.812,
  -65.604,-55.870,-43.295,-35.778,-27.241,-17.941, -2.322,  7.710, 10.811,
    4.737, -0.171, -6.549, -6.581, -5.465,-11.120,-21.834,-27.471,-33.103,
  -30.048,-25.694)
hn <- length(macdHisto)
histDir <- ifelse(macdHisto[hn] >= macdHisto[hn - 1], 'up', 'down')
#histoDiff <- diff(macdHisto)

SP <- c(
  2696,2713,2724,2748,2751,2748,2768,2786,2776,2803,2798,2810,2833,2839,2838,
  2839,2873,2854,2822,2824,2822,2762,2649,2695,2682,2581,2620,2656,2663,2699,
  2731,2732,2716,2701,2704,2747,2780,2744,2714,2678,2691,2721,2728,2727,2739,
  2787,2783,2765,2749,2747,2752,2713,2717,2712,2644,2588,2659,2613,2605,2641,
  2582,2614,2645,2663,2604,2613,2657,2642,2664,2656,2678,2706,2709,2693,2670,
  2670,2635,2639,2667,2670,2648,2655,2636,2630,2663,2673,2672,2698,2723,2728,
  2730,2711,2722,2710,2713,2733,2724,2733,2728,2721,2690,2724,2705,2735,2747,
  2749,2772,2770,2779,2782,2787,2776,2782,2780,2774,2763,2767,2750,2755,2717,
  2723,2700,2716,2718,2727,2713,2737,2760,2784,2794,2774,2798,2801,2798,2810,
  2816,2804,2802,2807,2820,2846,2837,2819,2803,2816,2813,2827,2840,2850,2858,
  2858,2854,2833,2822,2840,2818,2841,2850,2857,2863,2862,2857,2875,2897,2898,
  2914,2901,2902,2897,2889,2878,2872,2877,2888,2889,2904,2905,2889,2904,2908,
  2931,2930,2919,2916,2906,2914,2914,2925,2923,2926,2902,2886,2884,2880,2786,
  2728,2767,2751,2810,2809,2769,2768,2756,2741,2656,2706,2659,2641,2683,2712,
  2740,2723,2738,2755,2814,2807,2781,2726,2722,2702,2730,2736,2691,2642,2650,
  2633,2673,2682)

dailyChange <- function(x) {
  (x[2:length(x)] - x[1:(length(x) - 1)]) / x[1:(length(x) - 1)]
}

SP <- SP / SP[1]
SPd <- dailyChange(SP)

FidIn <- c(
  36984,36984,36984,36984,36984,36984,36984,36984,37033,37033,37033,37033,37033,
  37033,37033,37033,37033,37033,37033,37033,37352,37352,37352,37352,37352,37352,
  39257,39257,39257,39257,39572,39572,39572,39572,39572,39572,39572,39572,39572,
  39839,39839,39839,39839,39839,39839,39839,39839,39839,39839,39839,40086,40086,
  40086,40086,40086,40161,40161,40161,40161,40161,40380,40380,40380,40380,40380,
  40380,40380,40380,40380,40380,41152,41152,41152,41152,41152,41152,41178,41178,
  41178,41178,41436,41436,41436,41436,41436,41480,41480,41480,41480,41480,41480,
  41480,42458,42458,42458,42458,42458,42458,42458,42458,42458,42458,42458,42708,
  42708,42708,42708,42708,42708,42708,42708,42708,42708,42708,42967,42967,42967,
  42967,42967,42967,42967,42967,43010,43010,43341,43341,43341,43341,43341,43341,
  43341,43341,43341,43623,43623,43623,43623,43623,43623,43623,43623,43623,43623,
  43623,43623,43940,43940,43940,43940,43940,43940,43940,43940,43940,43940,43940,
  44186,44186,44186,44186,44186,44186,44186,44186,44186,44186,44186,44468,44468,
  44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,
  44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,
  44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,
  44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,44468,
  44468,44468,44468,44468,44468,44468,44468) #
FidVal <- c(
  36984,37199,37203,37554,37797,37799,37911,38107,37979,38242,38341,38609,38709,
  38744,38674,38797,38947,38729,38568,38684,38988,38717,38075,38057,37247,37247,
  39211,39389,39513,40540,41476,41419,41609,41492,41744,42195,42742,42207,42180,
  41892,42453,42759,42962,43263,43957,44301,44166,43834,43680,43562,43768,43242,
  43346,43338,43040,42865,43184,42791,42722,43061,42593,42914,43421,43675,43104,
  43211,43408,43481,43677,43463,44370,44706,44804,44747,44579,44500,44364,44345,
  44360,44295,44671,44849,45078,45034,45456,45630,45528,45965,46247,46113,45937,
  45850,47181,47312,47274,47338,47167,47435,47464,47577,47488,47527,47503,47853,
  48034,48095,48342,48211,48196,48174,48359,48282,48544,48588,48919,48688,48533,
  48419,48383,48250,48293,48214,48295,48263,48840,48688,48849,49077,49326,49284,
  49357,49868,49948,50185,50385,50515,50486,50359,50448,49963,50211,50056,49385,
  48526,48896,49273,49251,49242,49289,49295,49269,49280,49259,49216,49216,49216,
  49491,49491,49491,49491,49491,49491,49491,49571,49647,49801,49857,50105,50174,
  50190,50148,50143,50183,50214,50130,50223,50306,49777,49997,49978,50292,50325,
  49957,49888,49941,50068,50048,50042,49936,49961,49987,49933,49896,49703,49455,
  49399,49513,49525,49659,49553,48994,48697,48993,48656,47498,48456,47597,47194,
  47567,48288,48874,48229,48073,48409,49997,49750,49358,49178,49152,49057,49146,
  49096,47567,47046,47352,47273,47927,48099)
Fid <- FidVal / FidIn
Fidd <- dailyChange(Fid)

f1kIn <- c(
  22317,22317,22317,22317,22317,22317,22317,23129,23129,23129,23129,23129,23129,
  23129,23129,23129,23129,23129,23129,23129,24032,24032,24032,24032,24032,24032,
  24032,24032,24032,24032,24032,24938,24938,24938,24938,24938,24938,24938,24938,
  25836,25836,25836,25836,25836,25836,25836,25836,25836,25836,25836,26720,26720,
  26720,26720,26720,26720,26720,26720,26720,26720,27628,27628,27628,27628,27628,
  27628,27628,27628,27628,28728,28728,28728,28728,28728,28728,28728,28728,28728,
  28728,28728,29625,29625,29625,29625,29625,29625,29625,29625,29625,29625,29625,
  30511,30511,30511,30511,30511,30511,30511,30511,30511,30511,30511,31399,31399,
  31399,31399,31399,31399,31399,31399,31399,31399,31399,32275,32275,32275,32275,
  32275,32275,32275,32275,32275,32275,33168,33168,33168,33168,33168,33168,33168,
  33168,33168,34049,34049,34049,34049,34049,34049,34049,34049,34049,34049,34049,
  34049,34929,34929,34929,34929,34929,34929,34929,34929,34929,34929,34929,34929,
  35801,35801,35801,35801,35801,35801,35801,35801,35801,35801,35801,35801,36650,
  36650,36650,36650,36650,36650,36650,36650,37501,37501,37501,37501,37501,37501,
  37501,37501,37501,37501,37501,38352,38352,38352,38352,38352,38352,38352,38352,
  38352,38352,39271,39271,39271,39271,39271,39271,39271,39271,39271,39271,39271,
  39271,39271,40189,40189,40189,40189,40189,40189,40189,40189,40189,40189,41111,
  41111,41111,41111,41111,41111,41111,41111) #
f1kVal <- c(
  22317,22527,22713,23006,23006,23042,23263,24247,24247,24095,24290,24290,24487,
  24615,24711,24705,24705,24910,24789,24603,25541,25104,25104,24218,24457,24457,
  23635,23883,24225,24252,24432,25548,25568,25525,25439,25439,25638,25749,25575,
  26441,26321,26422,26548,26666,26706,26783,27005,27018,26947,26916,27813,27818,
  27661,27749,27741,27402,27135,27493,27215,27106,27764,27913,28162,28163,28246,
  27971,27972,28143,28143,28811,29326,29458,29699,29748,29669,29612,29581,29387,
  29387,29507,30037,30340,30300,30300,30313,30461,30542,30591,30690,30798,30800,
  31318,31685,31685,31693,31717,31784,31692,31741,31753,31743,31632,32387,32633,
  32765,32828,32882,32986,32918,32970,32988,33057,33000,33463,33994,34021,33902,
  33952,33811,33796,33469,33524,33274,33765,34413,34414,34386,34630,34742,34743,
  34749,34671,35082,35772,35650,35873,35873,35935,35887,35865,35692,36051,36051,
  35654,35325,36368,36578,36578,36566,36723,36833,36781,36845,36694,36557,36894,
  37441,37672,37962,37962,38146,38246,38226,38744,38802,38802,38786,38842,39815,
  39827,39524,39111,39380,39523,39622,39660,40802,40808,40388,40496,40752,40665,
  40666,40668,40503,40503,40580,41500,41307,41223,40659,40659,40371,40126,39938,
  38437,38438,39127,39546,40012,40013,39550,39552,39486,39377,38703,39064,38785,
  38636,39385,40133,40437,40362,40362,40884,40884,40853,40585,40136,40139,41187,
  41188,41242,40445,40608,40609,40538,40831)
f1k <- f1kVal / f1kIn
f1kd <- dailyChange(f1k)

OHIn <- c(
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,
  29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29475,29502,29502,
  29502,29502,29502,29502,29502,29502,29502,29502,29809,29809,29809,29809,29809,
  29809,29809,29501,29501,29972,29972,29972,29972,29972,29972,29972,29972,29972,
  30355,30355,30585,30585,30585,30585,30585,30697,30697,30849,30849,30849,30849,
  30849,31062,31062,31062,31166,31166,31166,31166,31166,31166,31219,31219,31459,
  31459,31459,31520,31708,31708,31708,31708) #
  
OHVal <- c(
  29475,29466,29488,29537,29624,29618,29697,29914,29671,29768,29740,30055,30237,
  30372,30211,30276,30360,30409,30365,30310,30388,30201,29883,29893,30009,30009,
  30271,30599,30824,31280,31330,31266,31378,31404,31254,31528,31605,31360,31316,
  31124,31398,31597,31798,31996,32111,32304,32440,32356,32452,32406,32332,32110,
  32206,32189,32089,31934,32112,31981,31867,31898,31685,31802,31871,31965,31832,
  31848,31909,31890,31933,31898,31919,32044,32092,32150,32091,32072,31957,31957,
  32072,32182,32169,32201,32176,32181,32198,32237,32221,32253,32255,32242,32240,
  32189,32211,32200,32185,32207,32199,32240,32243,32257,32234,32235,32235,32235,
  32235,32235,32235,32235,32235,32235,32235,32235,32235,32235,32235,32235,32235,
  32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,
  32236,32236,32236,32236,32235,32235,32235,32235,32235,32235,32235,32235,32236,
  32235,32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,32236,
  32236,32236,32236,32236,32236,32236,32236,32173,32321,32424,32336,32288,32288,
  32288,32288,32288,32288,32635,32691,32729,32685,32438,32818,32912,32832,32645,
  32287,32287,31953,31953,32464,32464,32464,32464,32464,32464,32464,32464,32464,
  32879,32879,33129,33129,33099,32601,32285,32466,32202,31680,32020,31669,31278,
  31971,32496,32768,32865,32585,32840,33519,33197,32618,32618,32673,32673,32924,
  32981,32744,32287,32612,32561,32655,32741)
OH <- OHVal / OHIn
OHd <- dailyChange(OH)

totalFunds <- FidVal + f1kVal + OHVal


# Current strategy (currents)
m1 <- (c(
  100000,100000,100000,100000,100000,100000,100000,100000,100000,100000,100000,
  100000,100000,100000,100000,100000,100000,100000,100000, 99028, 98330, 96867,
   94604, 95665, 92614, 92622, 93479, 94978, 95916,100300,101401,101691,102323,
  102339,103218,105538,107319,105536,105737,102946,103964,105247,105962,107542,
  110286,110809,110568,109320,108444,108028,107622,105552,105798,105838,104348,
  103146,104526,103009,102906,104090,101954,103433,104535,105368,103573,103289,
  105341,105714,106612,106865,108131,109634,109776,109151,108426,108667,105935,
  105935,106014,106923,106810,106354,105164,105329,106282,107472,107914,108223,
  108800,108783,107670,107350,108022,108499,108396,109744,108819,109800,110669,
  110634,110327,112095,111068,112724,113796,113955,115995,115347,116978,116978,
  118499,118726,120205,120563,120456,118661,119062,119061,119284,118463,118734,
  118301,118963,119071,119237,119242,120109,120840,121467,121217,121361,122364,
  122129,121073,121157,120935,120516,120026,124339,122380,123449,122714,122235,
  120339,121104,121261,121250,121444,121325,121718,121218,121127,121088,121050,
  121072,121139,121135,121135,121135,121135,121135,121135,121135,121135,121135,
  121135,121135,121135,121135,121135,121135,121135,121135,122748,122650,123691,
  125027,122802,124492,123980,124310,124356,123290,123297,123266,123328,123269,
  123359,123288,123279,123367,123331,123375,123241,122748,122602,122628,122607,
  122668,122189,118959,116985,117876,116109,110444,113950,111537,109849,113780,
  116028,117689,117556,116756,117707,122290,120736,116438,110163,110985,109139,
  112816,110846,104096,100575,102711,101918,104474,105580)
  / 100000)
  
# Buy and hold all (sell only if maxed out)  (bhAll)
m2 <- (c(
  100000,100000,100000,100104,101107,101164,102122,102737,101263,102358,102089,
  103631,104174,104791,105190,106025,108311,107118,105760,104482,103877,100610,
   95022, 97799, 91256, 91258, 93671, 96827, 99153,104309,106455,106324,107723,
  107080,107012,110049,112543,110164,109111,105412,106917,108990,111156,113342,
  115882,117635,117401,115737,115923,115690,115333,112389,114904,114136,109240,
  104890,111430,105619,103291,107243,101662,103133,105445,107146,102820,103761,
  107918,107783,110089,108820,110725,113923,115518,114787,113861,113435,108847,
  108847,112249,112588,112743,110597,109528,110360,111244,114229,113904,115509,
  116765,117242,115601,114915,116321,116501,117101,118873,117074,118974,119563,
  120051,119747,122450,121855,125390,128204,129297,131755,127859,129159,129498,
  132689,132854,136098,136572,137625,135316,135475,134189,132484,124904,126890,
  122433,125898,125843,127040,125974,127719,129853,130557,128823,128308,132181,
  131891,131416,132947,132707,131987,131029,133141,130299,133946,133130,130162,
  124454,124933,126685,128745,127850,129703,130624,131867,133712,133065,131386,
  131373,128758,128378,129332,131507,132641,133846,134076,136956,138922,139953,
  141226,140009,141247,142226,133613,134819,142300,143786,146823,148180,148551,
  147997,142294,145073,145765,146345,144151,142117,143360,144255,145799,145362,
  144518,139854,140902,136616,133200,129115,126420,113955,112142,119591,117554,
  126581,126991,120407,114931,117300,116187,105192,110828,105754,104175,109110,
  115506,120937,117911,116033,117646,125680,122265,116464,108135,109376,107396,
  112445,110035,103293,101579,103337,103616,106486,106488)
  / 100000) #
  #                           zbra nyt      atvi aapl          ndaq rpm              
  #                   unp ilmn         amgn           bkng
  # newr   nvda               nue
  # bb cme      masi                                       alk
  # oldest

# Buy and hold best (sell only if maxed out) (bhBest)
m3 <- (c(
  100000,100000,100000, 99931,100314,100323,100595,100763,100758,101010,100982,
  101614,101640,101771,101727,101819,101463,101006,100693,100388,100956,100333,
   99874, 99759, 99214, 99216, 99192, 99733,100222,101017,101004,101661,102368,
  102221,102008,102353,102837,102438,102245,101608,102251,103093,103207,103971,
  106260,105108,104637,104575,104169,103765,103765,103264,104138,104394,103701,
  102466,104095,102752,102973,103549,102273,103110,103532,103882,102707,102726,
  103631,104244,104444,103885,104285,105310,105002,104850,104803,105083,103202,
  103202,104324,104504,104655,105191,105275,106192,107340,108004,108466,109738,
  111125,111261,109754,109917,110476,110715,111258,112413,110558,111529,112112,
  113312,114779,116472,116917,118660,120418,119817,119992,118591,119727,119587,
  121274,121342,122738,123783,124605,122488,123172,121441,120032,116857,117644,
  114765,117374,117688,119446,118834,120389,122301,122683,121694,121822,126076,
  125933,125564,127924,128282,127649,127626,128659,125169,128368,128252,123985,
  118610,119393,121971,124230,122717,125417,125925,125427,127192,126768,125782,
  126878,125126,125696,126379,126631,127329,128791,129466,132271,132359,133256,
  134450,133979,134509,136552,131616,132407,140000,141716,143304,143925,142658,
  142818,138357,139072,137273,138747,136155,135778,136692,136284,137279,135930,
  134619,130289,130726,127451,126292,122088,119988,112742,110960,116186,116022,
  123113,126991,118343,114419,116247,115060,106458,111196,106264,105044,108373,
  113673,118089,115138,113180,113962,125680,121700,117490,109641,110875,109803,
  115133,114355,103527,100473,105243,105571,109141,108396)
  / 100000)
  # zbra aapl zbra unp alk alk atvi amgn newr okta crus fico fico mtn # oldest

# nnmod (strictly) [buy and sell at prescribed %s]
m4 <- (c(
  100000,100000,100000,100000,100000,100000,100000,100000,100000,100000,100000,
  100000,100000,100000,100000,100000,100000,100000,100000, 98394, 98728, 95333,
   89008, 89719, 84235, 84213, 86497, 90254, 92739, 97818, 99540, 99281, 99868,
   99175, 99688,102023,104009,100579, 99970, 96978,100080,101340,102927,105073,
  108148,110850,111248,109372,109100,108843,108363,106060,108275,107458,102429,
   99041,105006, 99889, 98917,102883, 98110, 99440,101556,102252, 98422, 99716,
  102780,102646,104943,102967,105366,109084,110029,109410,108630,108925,104798,
  104798,105652,104524,105607, 99556, 97859, 98888,100689,103310,104640,107432,
  110173,111460,109083,108729,110236,111308,112724,114285,111513,113466,114519,
  115585,114861,118448,117467,121471,122420,122589,124469,121968,123661,124555,
  127260,127106,128203,128799,129654,127502,126727,125833,125472,124461,124793,
  124021,124532,124359,124708,124382,124936,125745,126785,126360,126423,128788,
  129023,128793,129901,130195,130194,130136,130586,128434,129590,129231,126869,
  123761,123286,124070,125312,124593,125338,126093,125720,126408,126210,125762,
  127151,125966,125984,125514,126449,127829,129212,129619,133078,133862,134622,
  135867,135724,136401,138525,132536,133095,136817,139055,141617,141212,141338,
  141894,137674,139269,138741,139119,138408,137972,138588,138527,139126,140547,
  139919,136610,137384,134634,131891,129123,127884,117892,114899,121552,119195,
  127036,127985,123079,119145,120919,119466,110509,115577,111933,110219,113948,
  117751,121686,120268,119181,120903,129278,126548,122561,115605,116364,114564,
  118198,114933,105173,102487,104059,104093,107636,108279)
  / 100000)
# nnmod_current [universe is held and Nows; buy if >1, sell if <1]
m5 <- (c(
  100000,100000,100000,100000,100000,100000,100000,100000,100000,100000,100000,
  100000,100000,100000,100000,100000,100000,100000,100000, 99220, 98695, 97245,
   94955, 96021, 93271, 93271, 94400, 95978, 96664,101076,102618,103189,103853,
  103302,103870,106043,108278,106962,107084,103654,104873,106740,107598,108716,
  111443,111943,111149,110141,109808,109242,108975,106749,107339,107183,105887,
  104489,106071,103411,102800,104326,102370,102992,103385,103594,102215,102174,
  103502,103672,104904,104322,104765,106317,107112,106542,106133,105369,103320,
  103320,106014,102675,103140,102864,102760,102861,102861,102989,102885,102961,
  102851,102858,102890,102969,103211,103223,103822,104014,103305,103611,103399,
  103659,103580,103772,103689,104161,104937,104950,105549,105337,105638,105570,
  106185,106067,106882,106797,106825,106162,106317,106352,106361,106283,106275,
  106274,106401,106437,106521,106538,106794,107043,107449,107467,107753,108339,
  108355,107958,108016,108084,107806,107649,109095,108352,108713,108231,107832,
  106860,107175,107138,107119,107222,107184,107155,107002,107080,107019,107079,
  107079,107079,107079,107079,107079,107079,107079,107079,107079,107079,107079,
  107079,107079,107079,107079,107097,107079,107079,107079,108075,107221,108352,
  109382,108146,108869,108114,108251,108435,107189,106842,107132,107699,107660,
  107325,106875,107002,107044,106821,106591,105767,105057,104927,105459,105552,
  106147,106018,102461,100747,101653,100078, 95367, 98706, 96253, 94467, 98019,
   99644,101156,100571, 99682,100642,104477,103179, 99296, 94060, 94966, 93313,
   96292, 94009, 87880, 85334, 87510, 87160, 89396, 90498)
  / 100000)

n <- length(m1)

totin <- FidIn + f1kIn + OHIn
totval <- FidVal + f1kVal + OHVal
tot <- totval / totin
tot <- tot / tot[1]

m1 <- m1 / m1[1]
m2 <- m2 / m2[1]
m3 <- m3 / m3[1]
m4 <- m4 / m4[1]
m5 <- m5 / m5[1]


# Calculate Sharpe Ratios
Sharpe <- function(returns, window=length(returns)) {
  if (length(returns) > window) {
    returns <- returns[(length(returns) - window):length(returns)]	  	
  }
	
  returns <- returns[!is.na(returns)]
  (sqrt(252) * mean(returns)) / sd(returns)
}

get.daily.returns <- function(x) { 
  n <- length(x)
  x[2:n] / x[1:(n - 1)] - 1 
}

SP.sh  <- round(Sharpe(get.daily.returns(SP)), 3)
tot.sh <- round(Sharpe(get.daily.returns(tot)), 3)
m1.sh  <- round(Sharpe(get.daily.returns(m1)), 3)
m2.sh  <- round(Sharpe(get.daily.returns(m2)), 3)
m3.sh  <- round(Sharpe(get.daily.returns(m3)), 3)
m4.sh  <- round(Sharpe(get.daily.returns(m4)), 3)
m5.sh  <- round(Sharpe(get.daily.returns(m5)), 3)

plot(m1, 
     type='l', 
     ylim=range(c(SP, 
                  tot, 
                  1 + tot - SP, 
                  m1, 
                  m2,
                  m3,
                  m4,
                  m5)), 
     lwd=3,
     log='y')
abline(h=1, lty=4)
abline(h=seq(0, 3, 0.1), lty=2, col=rgb(0, 0, 0, 0.2))
lines(tot, col=2, lwd=3)
lines(SP, col='yellow', lwd=3)
lines(m2, lwd=3, col='coral')
lines(m3, lwd=3, col='blue')
lines(m4, lwd=3, col='purple')
lines(m5, lwd=3, col='cyan')
lines(1 + tot - SP, col='#880000')
legend(
  'topleft', 
  lty=1, 
  lwd=c(3, 3, 3, 3, 3, 3, 3, 1), 
  col=c('black', 'red ', 'yellow',  'coral', 'blue', 'purple', 'cyan', '#880000'),
  legend=c(paste(m1.sh, 'Current Ideal'), 
           paste(tot.sh, 'Actual'), 
           paste(SP.sh, 'S&P'), 
           paste(m2.sh, 'BuyNHold All'), 
           paste(m3.sh, 'BuyNHold Best'), 
           paste(m4.sh, 'NN Mod'), 
           paste(m5.sh, 'NN Current'), 
           'Actual Diff'),
  bty='n')
# ______________________________________________________________________________


quartz()
x <- 1:length(totalFunds)
plot(x, 
     totalFunds, 
     type = 'l', 
     ylim=c(0, max(totalFunds)), 
     main='1 = 01 Jan 2018')#, log='y')
#savings.mod <- lm(totalFunds ~ x)

exp.mod <- function(funds, x) {
  savings.exp.mod <- lm(log(funds) ~ x)
  log.y <- coef(savings.exp.mod)[1] + x*coef(savings.exp.mod)[2]
  exp(log.y)  
}


#abline(savings.mod, col=rgb(0, 0, 0, 0.25))
lines(x, exp.mod(totalFunds, x), col=rgb(0, 0, 0, 0.25))
abline(h=totalFunds[length(totalFunds)], col='grey')
abline(h=totalFunds[1], col='grey')
abline(h=min(totalFunds), col=2)
abline(h=max(totalFunds), col=3)

lines(FidVal, col=4)
lines(x, exp.mod(FidVal, x), col=rgb(0, 0, 1, 0.25))

lines(f1kVal, col=5)
lines(x, exp.mod(f1kVal, x), col=rgb(0, 1, 1, 0.25))

lines(OHVal, col=6)
lines(x, exp.mod(OHVal, x), col=rgb(1, 0, 1, 0.25))

legend('topleft', 
       text.col=c('green', 'black', 'red'), 
       legend=c(sprintf('$%d', max(totalFunds)),
                sprintf('$%d', totalFunds[length(totalFunds)]),
                sprintf('$%d', min(totalFunds))), 
       bg=rgb(1, 1, 1, 0.75))
legend('bottomright',
       lty=1,
       col=c(4, 5, 6, 1),
       legend=c('Fidelity', '401(k)', 'E*Trade', 'Total'),
       bg=rgb(1, 1, 1, 0.75))

day <- length(f1kIn) - 1 # length(<some new algo>) - 1
# Pad with leading NAs to make all vectors of equal length
tLength <- length(SP)
#Fid     <- c(rep(NA, tLength - length(Fid)),     Fid)
#OH      <- c(rep(NA, tLength - length(OH)),      OH)
#f1k     <- c(rep(NA, tLength - length(f1k)),     f1k)
days <- seq(to=day, by=1, length=tLength)

d <- data.frame(SP, Fid, OH, f1k)
realWts <- matrix(data=c(FidVal, OHVal, f1kVal), ncol=3)
realWts <- realWts / rowSums(realWts, na.rm = T)
realWts[is.na(realWts)] <- 0 
nWts <- length(realWts[, 1])
meanReal <- (Fid[(length(Fid) - nWts + 1):length(Fid)] * realWts[, 1] +
             OH[(length(OH)   - nWts + 1):length(OH)]  * realWts[, 2] +
             f1k[(length(OH)  - nWts + 1):length(f1k)] * realWts[, 3])
#meanReal <- c(rep(NA, 249), meanReal)
colors <- c(
  SP = 'yellow', Fid = 'red', OH = 'green', f1k = '#cc0088', meanReal = 'grey')			   
quartz()
matplot(days, d, type = 'l', lty = 1, col = colors, 
		lwd = 2, main = 'Performance of Funds (2018)',
	  	xlab = 'Market Days Elapsed', ylab = 'Times Original Value', 
	  	log = 'y', 
	  	xlim = c(0, day + 5), 
	  	ylim = c(min(d[days >= 0, ], meanReal - SP + 1, na.rm=T), 
	  			 max(d[days >= 0, ], meanReal - SP + 1, na.rm=T)))
lines(days, (meanReal - SP) + 1, lwd=1)
lines(days, d[, 'SP'], col = 'yellow', lwd=3)
lines(days, meanReal, col = colors['meanReal'], lwd=1)

abline(h = 1, lwd = 2)
abline(v = 0, lwd = 2)
#abline(v=c(30, 75), lty=4, col=rgb(0, 0, 0, 0.4))
abline(h=seq(0.1, 5.0, 0.1), col=rgb(0, 0, 0, 0.4), lty=2:1)

SP.Sharpe   <- round(Sharpe(SPd),  3)
Fid.Sharpe  <- round(Sharpe(Fidd), 3)
OH.Sharpe   <- round(Sharpe(OHd),  3)
f1k.Sharpe  <- round(Sharpe(f1kd), 3)
real.Sharpe <- round(Sharpe(dailyChange(meanReal)), 3)   

SP.Sharpe1yr   <- round(Sharpe(SPd,  250), 3)
Fid.Sharpe1yr  <- round(Sharpe(Fidd, 250), 3)
OH.Sharpe1yr   <- round(Sharpe(OHd,  250), 3)
f1k.Sharpe1yr  <- round(Sharpe(f1kd, 250), 3)
real.Sharpe1yr <- round(Sharpe(dailyChange(meanReal), 250), 3)

legend(
  'topleft', 
  title='All data',
  legend=c(
    sprintf('%11s: %+.3f', 'SP500',  SP.Sharpe), 
    sprintf('%15s: %+.3f', 'Fid',    Fid.Sharpe), 
    sprintf('%13s: %+.3f', 'OH',     OH.Sharpe), 
    sprintf('%15s: %+.3f', 'f1k',    f1k.Sharpe), 
    sprintf('%s: %+.3f', 'meanReal', real.Sharpe),
    sprintf('%s', 'diff')),
  lty=1, 
  col=c(colors, 'black'), 
  lwd=c(2, 2, 2, 2, 1, 1), 
  bg=rgb(1, 1, 1, 0.8), 
  cex=0.6)
legend(
  'bottomleft', 
  title='Last year only',
  legend = c(
    sprintf('%11s: %+.3f', 'SP500',  SP.Sharpe1yr), 
    sprintf('%15s: %+.3f', 'Fid',    Fid.Sharpe1yr), 
    sprintf('%13s: %+.3f', 'OH',     OH.Sharpe1yr), 
    sprintf('%15s: %+.3f', 'f1k',    f1k.Sharpe1yr), 
    sprintf('%s: %+.3f', 'meanReal', real.Sharpe1yr),
    sprintf('%s', 'diff')),
  lty=1, 
  col=c(colors, 'black'), 
  lwd=c(2, 2, 2, 2, 1, 1), 
  bg=rgb(1, 1, 1, 0.8), 
  cex=0.6)





# THE RULES
# Extremes are overbought/oversold RSI(14) 30/70 or
# 0.003/0.997
# At the extreme lows: all in
# At extreme highs: 25% of total goes into off-limit fund 
# 25% of all deposits go into off-limit fund
if (RSI > 70.00) {
  cat('Extreme High State: Move 25% of all funds into off-limits')
} else if (RSI < 30.00) {
  if (histDir == 'up') {
    cat('Extreme Low State: Invest all off-limit funds')	
  } else {
  	cat('Extreme Low State: Invest all off-limit funds when direction ',
  	    'changes to "up"')	
  } 
} else {
  if (histDir == 'up') {
    cat('Normal Upward State: Buy')
  } else {
  	cat('Normal Downward State: Sell, but do not buy')
  }
}

# Fidelity = MF
# E*Trade = Stocks
# 401(k) = 60-day

today.signal <- 'bottom' # HARD CODE
#today.signal <- 'falling'  # HARD CODE

signals <- c('none', 'peak', 'falling', 'bottom', 'rising')
actions <- c('none', 'sell', 'sell',    'buy',    'buy')
percents <- c(0,      0,      0.8989,    0.5677,   0.4456) # stocks
#percents <- c(0,      0,      0.319,     0.9285,   0) # 401(k)

ind <- which(signals == today.signal)
action <- actions[ind]
percent <- percents[ind]

# Total amount in portfolios
oh.amt  <- 32655 # [29240, 33519]
oh.inv  <- 15744
fid.amt <- 47926 # [33193, 50325]
(total.amt <- oh.amt + fid.amt)            # 80581
RESERVE <- 4011
(WATER <- 0.01 * (total.amt - RESERVE))    # 766 # next: 1000
(total.amt <- total.amt - RESERVE - WATER) # 75804


# Amt currently invested
(roll.inv <- 1746 + 6019 + 5747) # Don't include water WTR
(roth.inv <- 1921 + 1581 + 1935 + 7210 + 1531)
(si.inv   <- 0)
(total.inv <- oh.inv + roll.inv + roth.inv + si.inv)
(reserve <- total.amt - total.inv)

if (action == 'buy') {
  spend.amt <- reserve * percent
  cat('Today\'s signal: ', today.signal, '--', action, ' ', percent, ': ', 
      spend.amt, sep = '')
} else if (action == 'sell') {
  sell.amt <- total.inv * percent
  cat('Today\'s signal: ', today.signal, '--', action, ' ', percent, ': ', 
      sell.amt, sep = '')
} else {
  cat('Today\'s signal: ', today.signal, '--', action, ' ', 
      '(Sell only if stock gives signal; buy to replace value)', sep = '')
}

# For 401(k): 
# Use old bottom indicators for all-in (stocks). Sell off stocks ONLY if blue or yellow signal; otherwise always invest 75% in stocks, 25% in bonds
(f1k.total <- f1kVal[length(f1kVal)]) # 40585
RESERVE <- 1965
(fik.total <- f1k.total - RESERVE)    # 37692



x <- 1:length(totalFunds)
savings.exp.mod <- lm(log(totalFunds) ~ x)
x <- seq(250, 3250, by=250)[1:12]
log.y <- coef(savings.exp.mod)[1] + x*coef(savings.exp.mod)[2]
(y <- round(exp(log.y)))

sample(stocks, 3)